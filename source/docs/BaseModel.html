<!DOCTYPE html>  <html> <head>   <title>BaseModel.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="AppRules.html">                 AppRules.coffee               </a>                                           <a class="source" href="BaseCollection.html">                 BaseCollection.coffee               </a>                                           <a class="source" href="BaseModel.html">                 BaseModel.coffee               </a>                                           <a class="source" href="BaseRouter.html">                 BaseRouter.coffee               </a>                                           <a class="source" href="BaseView.html">                 BaseView.coffee               </a>                                           <a class="source" href="ConfigModel.html">                 ConfigModel.coffee               </a>                                           <a class="source" href="Cookie.html">                 Cookie.coffee               </a>                                           <a class="source" href="CrippledClientSync.html">                 CrippledClientSync.coffee               </a>                                           <a class="source" href="Helpers.html">                 Helpers.coffee               </a>                                           <a class="source" href="JSONAuthSync.html">                 JSONAuthSync.coffee               </a>                                           <a class="source" href="LocalStorageSync.html">                 LocalStorageSync.coffee               </a>                                           <a class="source" href="MenuHelper.html">                 MenuHelper.coffee               </a>                                           <a class="source" href="Messenger.html">                 Messenger.coffee               </a>                                           <a class="source" href="Store.html">                 Store.coffee               </a>                                           <a class="source" href="UserModel.html">                 UserModel.coffee               </a>                                           <a class="source" href="WorkspaceCanvasView.html">                 WorkspaceCanvasView.coffee               </a>                                           <a class="source" href="WorkspaceController.html">                 WorkspaceController.coffee               </a>                                           <a class="source" href="WorkspaceLoginView.html">                 WorkspaceLoginView.coffee               </a>                                           <a class="source" href="WorkspaceNavView.html">                 WorkspaceNavView.coffee               </a>                                           <a class="source" href="WorkspaceRouter.html">                 WorkspaceRouter.coffee               </a>                                           <a class="source" href="WorkspaceStateCollection.html">                 WorkspaceStateCollection.coffee               </a>                                           <a class="source" href="WorkspaceStateModel.html">                 WorkspaceStateModel.coffee               </a>                                           <a class="source" href="app_test.html">                 app_test.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="xmlSync.html">                 xmlSync.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               BaseModel.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;jquery&#39;</span><span class="p">,</span> 
  <span class="s">&#39;underscore&#39;</span><span class="p">,</span>
  <span class="s">&#39;backbone&#39;</span><span class="p">,</span>
  <span class="s">&#39;Store&#39;</span><span class="p">,</span>
  <span class="s">&#39;amplify&#39;</span><span class="p">,</span>
  <span class="s">&#39;LocalStorageSync&#39;</span><span class="p">,</span>
  <span class="s">&#39;CrippledClientSync&#39;</span><span class="p">,</span>
  <span class="s">&#39;JSONAuthSync&#39;</span><span class="p">,</span>
  <span class="s">&#39;Helpers&#39;</span><span class="p">,</span>
  <span class="s">&#39;xmlSync&#39;</span>
<span class="p">],</span> <span class="nf">($, _, Backbone, Store, amplify, LocalStorageSync, CrippledClientSync, JSONAuthSync, Helpers, XMLSync) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>BaseModel</h3>

<p>All models for PC 2.0 should inherit from BaseModel. This provides sync
adapters for localStorage and XML handling, in addition to standard
Backbone JSON handling. </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BaseModel = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>make Helpers functions available to all models</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">Helpers : </span><span class="nx">Helpers</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>store a ref to Backbone's sync so we can use it again</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">backboneSync  : </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Traditional Backbone JSON sync + Basic Auth</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">backboneAuthSync : </span><span class="nx">JSONAuthSync</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>store a ref to Backbone's parse so we can use it again</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">backboneParse : </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parse</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Deal with Crippled Clients</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">crippledClientSync  : </span><span class="nx">CrippledClientSync</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Setup XML parsing using CrippledClient</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">xmlSync  : </span><span class="nx">XMLSync</span>
    <span class="nv">xmlParse : </span><span class="nf">(response, xhr) -&gt;</span>
      <span class="nv">tree   = </span><span class="nx">response</span> <span class="k">if</span> <span class="nx">response</span><span class="o">?</span>
      <span class="nv">xmlstr = </span><span class="k">if</span> <span class="nx">response</span><span class="o">?</span><span class="p">.</span><span class="nx">xml</span><span class="o">?</span> <span class="k">then</span> <span class="nx">response</span><span class="p">.</span><span class="nx">xml</span> <span class="k">else</span> <span class="p">(</span><span class="k">new</span> <span class="nx">XMLSerializer</span><span class="p">()).</span><span class="nx">serializeToString</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span>
      <span class="nv">tree   = </span><span class="nx">$</span><span class="p">.</span><span class="nx">parseXML</span><span class="p">(</span><span class="nx">xmlstr</span><span class="p">)</span>
      <span class="nv">out = </span><span class="p">{</span> <span class="s">&#39;xhr&#39;</span> <span class="o">:</span> <span class="nx">xhr</span> <span class="p">}</span>
      <span class="k">if</span> <span class="nx">tree</span><span class="o">?</span>
          <span class="nv">out.document   = </span><span class="nx">$</span><span class="p">(</span><span class="nx">tree</span><span class="p">)</span>
          <span class="nv">out.raw_xml    = </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>out.string_xml = xmlstr</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">out.json       = </span><span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">xml2json</span><span class="p">(</span><span class="nx">out</span><span class="p">.</span><span class="nx">raw_xml</span><span class="p">)</span>
      <span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Response state (Hackety hack hack)</p>

<p>Since we're on <strong>Crippled Client</strong>, all requests come back as
200's and we have to do header parsing to ascertain what 
is actually going on. We stash the jqXHR in the model and
do some checking to see what the error code really is, then
stash that in the model as 'fetch_state'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">response_state : </span><span class="nf">() -&gt;</span>
      <span class="nv">xhr = </span><span class="nx">@get</span> <span class="s">&#39;xhr&#39;</span>
      <span class="nv">fetch_state =</span>
        <span class="nv">text : </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span> <span class="s">&#39;X-True-Statustext&#39;</span>
        <span class="nv">code : </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span> <span class="s">&#39;X-True-Statuscode&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>This might be a CORS request in which case we can't
get our X-True-Statustext so we need to wing it.
This could still cause us some problems down the road.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">fetch_state</span><span class="p">.</span><span class="nx">code</span><span class="o">?</span>
        <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">is</span> <span class="mi">4</span> <span class="o">and</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">200</span>
          <span class="nv">fetch_state.code = </span><span class="s">&quot;200&quot;</span>

      <span class="nx">@set</span> <span class="s">&#39;fetch_state&#39;</span><span class="p">,</span> <span class="nx">fetch_state</span>
      <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Explicitly set sync for this model to Backbone default</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">sync : </span><span class="nx">@backboneSync</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Switch models sync to another adapter</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">switch_sync : </span><span class="nf">(sync_adapater) -&gt;</span>
      <span class="vi">@sync = </span><span class="nx">@</span><span class="p">[</span><span class="nx">sync_adapater</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Tell model to fetch &amp; parse XML data</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">use_xml : </span><span class="nf">() -&gt;</span>
      <span class="vi">@sync  = </span><span class="nx">@xmlSync</span>
      <span class="vi">@parse = </span><span class="nx">@xmlParse</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Tell model to fetch &amp; parse XML data from Crippled Clients</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">use_cripple : </span><span class="nf">() -&gt;</span>
      <span class="vi">@sync  = </span><span class="nx">@crippledClientSync</span>
      <span class="vi">@parse = </span><span class="nx">@xmlParse</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Tell model to use localStorage</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">use_localStorage : </span><span class="nf">(storage_key) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Setup localStorage DB in browswer</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@localStorage = </span><span class="k">new</span> <span class="nx">Store</span> <span class="nx">storage_key</span>
      <span class="vi">@localSync    = </span><span class="nx">LocalStorageSync</span>

      <span class="vi">@sync  = </span><span class="nx">@localSync</span>
      <span class="vi">@parse = </span><span class="nx">@backboneParse</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Switch back to traditional JSON handling</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">use_backbone : </span><span class="nf">() -&gt;</span>
      <span class="vi">@sync  = </span><span class="nx">@backboneSync</span>
      <span class="vi">@parse = </span><span class="nx">@backboneParse</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Switch back to traditional JSON handling + Basic Auth</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">use_backbone_auth : </span><span class="nf">() -&gt;</span>
      <span class="vi">@sync  = </span><span class="nx">@backboneAuthSync</span>
      <span class="vi">@parse = </span><span class="nx">@backboneParse</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>hook into Amplify.js on all models</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">Amplify : </span><span class="nx">amplify</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Simple logger pubsub</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">logger : </span><span class="nf">(msg) -&gt;</span>
      <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Send Flash messages to UI</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">flash : </span><span class="nf">(type, msg) -&gt;</span>
      <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;flash&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">msg</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 