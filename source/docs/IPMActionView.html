<!DOCTYPE html>  <html> <head>   <title>IPMActionView.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="IPMActionView.html">                 IPMActionView.coffee               </a>                                           <a class="source" href="IPMChangeSet.html">                 IPMChangeSet.coffee               </a>                                           <a class="source" href="IPMFormValidation.html">                 IPMFormValidation.coffee               </a>                                           <a class="source" href="IPMModule.html">                 IPMModule.coffee               </a>                                           <a class="source" href="IPMView.html">                 IPMView.coffee               </a>                                           <a class="source" href="PolicyModel.html">                 PolicyModel.coffee               </a>                                           <a class="source" href="PolicyModule.html">                 PolicyModule.coffee               </a>                                           <a class="source" href="PolicyView.html">                 PolicyView.coffee               </a>                                           <a class="source" href="ReferralAssigneesModel.html">                 ReferralAssigneesModel.coffee               </a>                                           <a class="source" href="ReferralQueueModule.html">                 ReferralQueueModule.coffee               </a>                                           <a class="source" href="ReferralQueueView.html">                 ReferralQueueView.coffee               </a>                                           <a class="source" href="ReferralTaskCollection.html">                 ReferralTaskCollection.coffee               </a>                                           <a class="source" href="ReferralTaskModel.html">                 ReferralTaskModel.coffee               </a>                                           <a class="source" href="ReferralTaskView.html">                 ReferralTaskView.coffee               </a>                                           <a class="source" href="RenewalUnderwritingModel.html">                 RenewalUnderwritingModel.coffee               </a>                                           <a class="source" href="RenewalUnderwritingView.html">                 RenewalUnderwritingView.coffee               </a>                                           <a class="source" href="SearchContextCollection.html">                 SearchContextCollection.coffee               </a>                                           <a class="source" href="SearchContextModel.html">                 SearchContextModel.coffee               </a>                                           <a class="source" href="SearchContextView.html">                 SearchContextView.coffee               </a>                                           <a class="source" href="SearchModule.html">                 SearchModule.coffee               </a>                                           <a class="source" href="SearchPolicyCollection.html">                 SearchPolicyCollection.coffee               </a>                                           <a class="source" href="SearchPolicyModel.html">                 SearchPolicyModel.coffee               </a>                                           <a class="source" href="SearchPolicyView.html">                 SearchPolicyView.coffee               </a>                                           <a class="source" href="SearchView.html">                 SearchView.coffee               </a>                                           <a class="source" href="ZenDeskView.html">                 ZenDeskView.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               IPMActionView.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;BaseView&#39;</span><span class="p">,</span>
  <span class="s">&#39;Messenger&#39;</span><span class="p">,</span>
  <span class="s">&#39;modules/IPM/IPMChangeSet&#39;</span><span class="p">,</span>
  <span class="s">&#39;modules/IPM/IPMFormValidation&#39;</span>
<span class="p">],</span> <span class="nf">(BaseView, Messenger, IPMChangeSet, IPMFormValidation) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>IPMActionView</h2>

<p>IPM sub views (action views) inherit from this base view  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">IPMActionView</span> <span class="k">extends</span> <span class="nx">BaseView</span>
    
    <span class="nv">tagName : </span><span class="s">&#39;div&#39;</span>

    <span class="nv">events :</span>
      <span class="s">&quot;click fieldset h3&quot;</span>     <span class="o">:</span> <span class="s">&quot;toggleFieldset&quot;</span>

    <span class="nv">initialize : </span><span class="nf">(options) -&gt;</span>
      <span class="vi">@PARENT_VIEW    = </span><span class="nx">options</span><span class="p">.</span><span class="nx">PARENT_VIEW</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="vi">@MODULE         = </span><span class="nx">options</span><span class="p">.</span><span class="nx">MODULE</span> <span class="o">||</span> <span class="p">{}</span>
      <span class="vi">@ChangeSet      = </span><span class="k">new</span> <span class="nx">IPMChangeSet</span><span class="p">(</span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">,</span> <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="p">,</span> <span class="nx">@MODULE</span><span class="p">.</span><span class="nx">USER</span><span class="p">)</span>
      <span class="vi">@FormValidation = </span><span class="k">new</span> <span class="nx">IPMFormValidation</span><span class="p">()</span>
      
      <span class="vi">@VALUES    = </span><span class="p">{}</span> <span class="c1"># Form values</span>
      <span class="vi">@TPL_CACHE = </span><span class="p">{}</span> <span class="c1"># Template Cache</span>
      <span class="vi">@ERRORS    = </span><span class="p">{}</span> <span class="c1"># Manage error states from server</span>
      
      <span class="vi">@options = </span><span class="kc">null</span>

      <span class="nx">@</span><span class="kc">on</span><span class="p">(</span><span class="s">&#39;ready&#39;</span><span class="p">,</span> <span class="nx">@ready</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>We need to validate form submits</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@submit</span><span class="p">)</span>
        <span class="vi">@submit = </span><span class="nx">_</span><span class="p">.</span><span class="nx">wrap</span> <span class="nx">@submit</span><span class="p">,</span> <span class="p">(</span><span class="nx">submit</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nv">args = </span><span class="nx">_</span><span class="p">.</span><span class="nx">toArray</span> <span class="nx">arguments</span>
          <span class="k">if</span> <span class="nx">@validate</span><span class="p">()</span>
            <span class="nx">submit</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p><strong>fetchTemplates</strong> grab the model.json and view.html for processing  </p>

<p>@param <code>policy</code> <em>Object</em> PolicyModel <br />
@param <code>action</code> <em>String</em> Name of this action <br />
@param <code>callback</code> <em>Function</em> function to call on AJAX success  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fetchTemplates : </span><span class="nf">(policy, action, callback) -&gt;</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">policy</span><span class="o">?</span> <span class="o">||</span> <span class="o">!</span><span class="nx">action</span><span class="o">?</span>
        <span class="k">return</span> <span class="kc">false</span>

      <span class="nv">path  = </span><span class="s">&quot;/js/</span><span class="si">#{</span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">CONFIG</span><span class="p">.</span><span class="nx">PRODUCTS_PATH</span><span class="si">}#{</span><span class="nx">policy</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;productName&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">/forms/</span><span class="si">#{</span><span class="nx">_</span><span class="p">.</span><span class="nx">slugify</span><span class="p">(</span><span class="nx">action</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Stash the files in the cache on first load</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@TPL_CACHE</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span>          
        <span class="nv">model = </span><span class="nx">$</span><span class="p">.</span><span class="nx">getJSON</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">/model.json&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">pipe</span> <span class="nf">(resp) -&gt;</span> <span class="k">return</span> <span class="nx">resp</span>        
        <span class="nv">view  = </span><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">path</span><span class="si">}</span><span class="s">/view.html&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s">&quot;text&quot;</span><span class="p">)</span>
                  <span class="p">.</span><span class="nx">pipe</span> <span class="nf">(resp) -&gt;</span> <span class="k">return</span> <span class="nx">resp</span>
        <span class="nx">$</span><span class="p">.</span><span class="k">when</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">view</span><span class="p">).</span><span class="k">then</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">actionError</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">action</span><span class="p">].</span><span class="nx">model</span><span class="p">,</span> <span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">action</span><span class="p">].</span><span class="nx">view</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><strong>Return to home page of IPM</strong>  </p>

<p>@param <code>e</code> <em>Event</em>  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">goHome : </span><span class="nf">(e) -&gt;</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">route</span> <span class="s">&#39;Home&#39;</span>        </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Open/close fieldsets </p>

<p>@param <code>e</code> <em>Event</em>  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">toggleFieldset : </span><span class="nf">(e) -&gt;</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="nv">h3        = </span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">)</span>
      <span class="nv">a         = </span><span class="nx">h3</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
      <span class="nv">container = </span><span class="nx">h3</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.collapsibleFieldContainer&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Toggle visibility states</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;display&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;none&#39;</span>
        <span class="nx">container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;display&#39;</span><span class="p">,</span> <span class="s">&#39;block&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">container</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;display&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Swap anchor text</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">a_html = </span><span class="nx">a</span><span class="p">.</span><span class="nx">html</span><span class="p">()</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;altText&#39;</span><span class="p">)).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;altText&#39;</span><span class="p">,</span> <span class="nx">a_html</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><strong>Post process the rendered view</strong>  </p>

<p>This is where we add things like required labels and such after the
ActionView has been rendered. You can add to this through inheritance
using <code>super</code> in your actions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">postProcessView : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Initial cancle button goes back to home screen</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.form_actions a&#39;</span><span class="p">).</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@goHome</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Set all Enum selects to their default values</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$</span><span class="p">(</span><span class="s">&#39;select[data-value]&#39;</span><span class="p">).</span><span class="nx">val</span> <span class="o">-&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;data-value&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Attach datepickers where appropriate</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">date_options = </span>
        <span class="nv">dateFormat : </span><span class="s">&#39;yy-mm-dd&#39;</span>

      <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">datepicker</span>
        <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.datepicker&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="nx">date_options</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Attach event listener to preview button</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;form input.button[type=submit]&#39;</span><span class="p">).</span><span class="kc">on</span><span class="p">(</span>
          <span class="s">&#39;click&#39;</span><span class="p">,</span>
          <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@submit</span> <span class="nx">e</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><strong>Post process the preview of the form</strong>  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">postProcessPreview : </span><span class="o">-&gt;</span>
      <span class="k">delete</span> <span class="nx">@viewData</span><span class="p">.</span><span class="nx">preview</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Swap out click event on cancel button to just reset to beginning state</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.form_actions a&#39;</span><span class="p">).</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="nx">@processView</span><span class="p">(</span>
          <span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="p">].</span><span class="nx">model</span><span class="p">,</span>
          <span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="p">].</span><span class="nx">view</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>.data_tables in the preview require additional hooks and processing</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.data_table&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">@processPreviewForm</span><span class="p">(</span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.data_table&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p><strong>Get the form values</strong>  </p>

<p>@param <code>form</code> <em>HTML Form Element</em> <br />
@return <em>Object</em> key:val object of form values  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getFormValues : </span><span class="nf">(form) -&gt;</span>
      <span class="nv">formValues = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">form</span><span class="p">.</span><span class="nx">serializeArray</span><span class="p">()</span>
        <span class="nx">formValues</span><span class="p">[</span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">value</span>
      <span class="nx">formValues</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><strong>Which form values changed?</strong>  </p>

<p>@param <code>form</code> <em>HTML Form Element</em> <br />
@return <em>Object</em> key:val object of changed form values  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">getChangedValues : </span><span class="nf">(form) -&gt;</span>
      <span class="nv">changed = </span><span class="p">[]</span>
      <span class="nx">form</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;:input&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, element) -&gt;</span>
        <span class="nv">el   = </span><span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
        <span class="nv">val  = </span><span class="nx">el</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
        <span class="nv">name = </span><span class="nx">el</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;name&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Check on data-value of <select> element  </p>

<p><em>Note:</em> We are explicity using '!=' instead of CoffeeScript's 
automatic conversion to '!==' because the values from the form
are all different types and we need loose comparisons to prevent 
writing a shit ton of explicit detections &amp; coercion code. 
This could cause an issue going forward, hence the note. - DN</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">el</span><span class="p">.</span><span class="o">is</span> <span class="s">&#39;select&#39;</span>
          <span class="k">if</span> <span class="o">`</span><span class="nx">el</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">val</span><span class="o">`</span>
            <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Check on <textarea> fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">else</span> <span class="k">if</span> <span class="nx">el</span><span class="p">.</span><span class="o">is</span> <span class="s">&#39;textarea&#39;</span>
          <span class="k">if</span> <span class="nx">val</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span>
            <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>
          <span class="k">if</span> <span class="nx">val</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;hadValue&#39;</span><span class="p">)</span>
            <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>

        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">val</span> <span class="o">!=</span> <span class="nx">element</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span>
            <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>

      <span class="nx">changed</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Use the vocabTerms (model.json) to derive the policy data the form needs 
specific to this ActionView and cache it.</p>

<p>@param <code>vocabTerms</code> <em>Object</em> model.json <br />
@param <code>view</code> <em>HTML Template</em> <br />
@return <em>Array</em> [viewData, view]  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">processViewData : </span><span class="nf">(vocabTerms, view) -&gt;</span>
      <span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="p">]</span> <span class="o">=</span>
        <span class="nv">model : </span><span class="nx">vocabTerms</span>
        <span class="nv">view  : </span><span class="nx">view</span>

      <span class="nv">viewData = </span><span class="p">{}</span>

      <span class="k">if</span> <span class="nx">vocabTerms</span><span class="o">?</span>
        <span class="nv">viewData = </span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">getTermDataItemValues</span><span class="p">(</span><span class="nx">vocabTerms</span><span class="p">)</span>
        <span class="nv">viewData = </span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">getEnumerations</span><span class="p">(</span><span class="nx">viewData</span><span class="p">,</span> <span class="nx">vocabTerms</span><span class="p">)</span>

      <span class="nv">viewData = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
        <span class="nx">viewData</span><span class="p">,</span>
        <span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">getPolicyOverview</span><span class="p">(),</span>
        <span class="p">{</span> 
          <span class="nv">policyOverview : </span><span class="kc">true</span>
          <span class="nv">policyId : </span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">get_pxServerIndex</span><span class="p">()</span>
        <span class="p">}</span>
      <span class="p">)</span>
      <span class="vi">@viewData = </span><span class="nx">viewData</span>
      <span class="vi">@view     = </span><span class="nx">view</span>

      <span class="p">[</span><span class="nx">viewData</span><span class="p">,</span> <span class="nx">view</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p><strong>Handle calculations in preview fields</strong> <br />
Some products can manipulate fields in the preview phase. We need to
attach some behaviors to those fields and then run the numbers. We also
need to attach some flags to the form so the submit handler will know
what to do on a "re-submit".</p>

<p>@param <code>table</code> <em>HTML Element</em> jQuery wrapped <table>  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">processPreviewForm : </span><span class="nf">(table) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Disable button until something changes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">update_button = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#updatePreview&#39;</span><span class="p">)</span>
      <span class="nx">update_button</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>if an Adjustment value is changed for either category then we need
to re-caclculate that category's Adjusted value</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">table</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;tr.calc_row input&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, val) -&gt;</span>
        <span class="nv">$input        = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="c1"># cache the jQuery wrapped element</span>
        <span class="nv">parentRow     = </span><span class="nx">$input</span><span class="p">.</span><span class="nx">closest</span> <span class="s">&#39;tr.calc_row&#39;</span>
        <span class="nv">unadjustedVal = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">$input</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">prev</span><span class="p">().</span><span class="nx">text</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span>
        <span class="nv">adjustedElem  = </span><span class="nx">$input</span><span class="p">.</span><span class="nx">parent</span><span class="p">().</span><span class="nx">next</span><span class="p">()</span>
        <span class="nv">subTotalElem  = </span><span class="nx">parentRow</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;td.subtotal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>As typing happens update this category's Adjustment value
http://stackoverflow.com/questions/5971645/what-is-the-double-tilde-operator-in-javascript#5971668</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$input</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;keyup&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
          <span class="nv">adjustmentVal = </span><span class="o">~~</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
          <span class="nv">subTotalView  = </span><span class="o">~~</span><span class="p">(</span><span class="nx">subTotalElem</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Update the adjustment value</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">adjustedElem</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">unadjustedVal</span> <span class="o">+</span> <span class="nx">adjustmentVal</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Re-calc subtotal</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">subTotalElem</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;adjust&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Re-enable button</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">update_button</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Each time either category's adjustment values are changes, we also need
to update Premium Before Fees (grandSubtotal)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">table</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;tr.calc_row&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, val) -&gt;</span>
        <span class="nv">$tr            = </span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="c1"># cache the jQuery wrapped element</span>
        <span class="nv">calculatedVals = </span><span class="nx">$tr</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;td.calculated_value&#39;</span>
        <span class="nv">subtotalElem   = </span><span class="nx">$tr</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;td.subtotal&#39;</span>
        <span class="nv">feesElem       = </span><span class="nx">$tr</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;td.fees&#39;</span>
        <span class="nv">totalElem      = </span><span class="nx">$tr</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;td.total&#39;</span>
        <span class="nv">originSubtotal = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">subtotalElem</span><span class="p">.</span><span class="nx">text</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span>
        <span class="nv">fees           = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">feesElem</span><span class="p">.</span><span class="nx">text</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span>
        <span class="nv">originTotal    = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">totalElem</span><span class="p">.</span><span class="nx">text</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span>

        <span class="nx">subtotalElem</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;adjust&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
          <span class="nv">newSubtotal = </span><span class="mi">0</span>
          <span class="nv">newTotal = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Subtotal is sum of calculated values</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">calculatedVals</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(i, val) -&gt;</span>
            <span class="nv">amt         = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">text</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span>
            <span class="nv">newSubtotal = </span><span class="nx">newSubtotal</span> <span class="o">+</span> <span class="nx">amt</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Subtotal is Cat plus NonCat Adjusted values. 1000 format.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">subtotalElem</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">newSubtotal</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>total is subtotal plus fees. 1000 format.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">totalElem</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">newSubtotal</span> <span class="o">+</span> <span class="nx">fees</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Create click handler for updatePreview button and inject hidden form
field into the DOM.</p>

<p>Maintain state within the table itself. I think this is to prevent
multiple submits of the new data</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">table</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;initialized&#39;</span><span class="p">)</span>
        <span class="nx">table</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;initialized&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nx">update_button</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;form&#39;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s">&#39;&lt;input type=&quot;hidden&quot; id=&quot;id_preview&quot; name=&quot;preview&quot; value=&quot;re-preview&quot;&gt;&#39;</span><span class="p">)</span>
          <span class="nx">@submit</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Attach event listener to confirm button, changing the value of the
hidden preview field to 'confirm'</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;form input[type=submit]&#39;</span><span class="p">).</span><span class="kc">on</span><span class="p">(</span>
          <span class="s">&#39;click&#39;</span><span class="p">,</span>
          <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;form input[name=preview]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="s">&#39;confirm&#39;</span><span class="p">)</span>
            <span class="nx">@submit</span> <span class="nx">e</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p><strong>Success handling from ChangeSet</strong></p>

<p>@param <code>data</code> <em>XML</em> Policy XML <br />
@param <code>status</code> <em>String</em> Status of callback <br />
@param <code>jqXHR</code> <em>Object</em> XHR object  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">callbackSuccess : </span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">msg = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="si">}</span><span class="s"> completed successfully&quot;</span>

      <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="s">&#39;success&#39;</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="mi">12000</span><span class="p">).</span><span class="nx">remove_loader</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Load returned policy into PolicyModel</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@resetPolicyModel</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span>

      <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">route</span> <span class="s">&#39;Home&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Re-render the form
@processView(
  @TPL<em>CACHE[@PARENT</em>VIEW.VIEW<em>STATE].model,
  @TPL</em>CACHE[@PARENT<em>VIEW.VIEW</em>STATE].view
)</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><strong>Error handling from ChangeSet</strong></p>

<p>@param <code>jqXHR</code> <em>Object</em> XHR object <br />
@param <code>status</code> <em>String</em> Status of callback <br />
@param <code>error</code> <em>String</em> Error  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">callbackError : </span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>If we don't get an XHR response, then something very bad has
happened indeed.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">jqXHR</span>
        <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">displayError</span><span class="p">(</span>
          <span class="s">&#39;warning&#39;</span><span class="p">,</span>
          <span class="s">&#39;Fatal: Error received with no response from server&#39;</span>
        <span class="p">).</span><span class="nx">remove_loader</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">false</span>

      <span class="k">if</span> <span class="nx">jqXHR</span><span class="p">.</span><span class="nx">responseText</span><span class="o">?</span>
        <span class="nv">regex = </span><span class="sr">/\[(.*?)\]/g</span>
        <span class="nv">json  = </span><span class="nx">regex</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>If this is an endorse action and the response is JSON then there is
a high chance this could be a rate validation error.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">json</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span> <span class="o">==</span> <span class="s">&#39;Endorse&#39;</span>
          <span class="vi">@ERRORS = </span><span class="nx">@errorParseJSON</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">,</span> <span class="nx">json</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="vi">@ERRORS = </span><span class="nx">@errorParseHTML</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">)</span>

      <span class="nx">@displayError</span> <span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="nx">@ERRORS</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p><strong>Preview Callback</strong> <br />
If a policy comes back to for Preview we need to do a little processing
before we display it to the user. This is called by ActionView as part
of the IPMChangeSet.commitChange() callback.</p>

<ul>
<li>First, inject the new policy XML into the model and setModelState()</li>
<li>Second, pass the view and model.js to ActionView.processPreview()</li>
</ul>

<p>@param <code>data</code> <em>XML</em> PolicyModel
@param <code>status</code> <em>String</em> Status of callback 
@param <code>jqXHR</code> <em>Object</em> XHR object  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">callbackPreview : </span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@resetPolicyModel</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span>
      <span class="nx">@processPreview</span><span class="p">(</span>
        <span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="p">].</span><span class="nx">model</span><span class="p">,</span>
        <span class="nx">@TPL_CACHE</span><span class="p">[</span><span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">VIEW_STATE</span><span class="p">].</span><span class="nx">view</span>
      <span class="p">)</span>
      <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">remove_loader</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p><strong>Load new XML into PolicyModel</strong>  </p>

<p>Inject the new policy XML into the model and setModelState()</p>

<p>@param <code>data</code> <em>XML</em> PolicyModel
@param <code>jqXHR</code> <em>Object</em> XHR object <br />
@return <em>Object</em> PolicyModel</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">resetPolicyModel : </span><span class="nf">(data, jqXHR) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Swap out Policy XML with new XML, saving the old one</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">new_attributes = </span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">jqXHR</span><span class="p">)</span>
      <span class="nv">new_attributes.prev_document = </span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;document&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Model.set() chokes on something in the object, so we just
jam the values into attributes directly. So sorry Mr. Ashkenas.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">new_attributes</span>
        <span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Tell the model to set its state based on the new XML values</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span>

      <span class="nx">@MODULE</span><span class="p">.</span><span class="nx">POLICY</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p><strong>Build view data objects and trigger loaded event</strong>  </p>

<p>Takes the model.json and creates a custom data object for this view. We
then trigger the <code>loaded</code> event passing @postProcessView as the callback. 
This will attach any necessary behaviors to the rendered form.  </p>

<p>@param <code>vocabTerms</code> <em>Object</em> model.json <br />
@param <code>view</code> <em>String</em> HTML template    </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">render : </span><span class="nf">(viewData, view) -&gt;</span>
      <span class="k">super</span>
      <span class="nv">viewData = </span><span class="nx">viewData</span> <span class="o">||</span> <span class="nx">@viewData</span>
      <span class="nv">view     = </span><span class="nx">view</span> <span class="o">||</span> <span class="nx">@view</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">@MODULE</span><span class="p">.</span><span class="nx">VIEW</span><span class="p">.</span><span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">viewData</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Validate form with IPMFormValidation and display any errors</p>

<p>@return <em>Boolean</em> </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">validate : </span><span class="o">-&gt;</span>
      <span class="nv">required_fields = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;input[required], select[required]&#39;</span><span class="p">)</span>
      <span class="nv">errors = </span><span class="nx">@FormValidation</span><span class="p">.</span><span class="nx">validateFields</span><span class="p">(</span><span class="nx">required_fields</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">errors</span>
        <span class="kc">true</span>
      <span class="k">else</span>
        <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span>
          <span class="s">&#39;warning&#39;</span><span class="p">,</span>
          <span class="nx">@FormValidation</span><span class="p">.</span><span class="nx">displayErrorMsg</span><span class="p">(</span><span class="nx">errors</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p><strong>Submit form</strong> - set the form values on the ActionView for 
use in inherited ActionViews. Only do this if there is an actual form,
otherwise we're probably in a preview state and need to hold onto the
original form values.</p>

<p><em>Note:</em> This method should be extended in child views</p>

<p>@param <code>e</code> <em>Event</em> Submit event (Optional) </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">submit : </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">e</span><span class="o">?</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

      <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">insert_loader</span><span class="p">(</span><span class="s">&#39;Processing policy&#39;</span><span class="p">)</span> <span class="c1"># Add loader</span>

      <span class="nv">form = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;form&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">form</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> 

        <span class="vi">@VALUES.formValues    = </span><span class="nx">@getFormValues</span> <span class="nx">form</span>
        <span class="vi">@VALUES.changedValues = </span><span class="nx">@getChangedValues</span> <span class="nx">form</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>If we have previous values then cons them onto the new values</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@VALUES</span><span class="p">,</span> <span class="s">&#39;previousValues&#39;</span><span class="p">)</span>
          <span class="vi">@VALUES.formValues = </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
            <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">previousValues</span><span class="p">.</span><span class="nx">formValues</span><span class="p">,</span>
            <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">formValues</span>            
          <span class="p">)</span>
          <span class="vi">@VALUES.changedValues = </span><span class="o">\</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">changedValues</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">@VALUES</span><span class="p">.</span><span class="nx">previousValues</span><span class="p">.</span><span class="nx">changedValues</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>In previews we need to keep the previous form states as we re-calc
and re-submit the TransactionRequests multiple times, making changes.
We purposefully delete the preview field in our saved set as we don't
want it overriding the combined value later (we use it to trigger
things.) We use _.clone because we want the data, not a ref to the obj</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">@VALUES</span><span class="p">.</span><span class="nx">formValues</span><span class="p">,</span> <span class="s">&#39;preview&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">formValues</span><span class="p">.</span><span class="nx">preview</span> <span class="o">!=</span> <span class="s">&#39;confirm&#39;</span>
          <span class="vi">@VALUES.previousValues = </span>
            <span class="nv">formValues    : </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">formValues</span>
            <span class="nv">changedValues : </span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">changedValues</span>
          <span class="k">delete</span> <span class="nx">@VALUES</span><span class="p">.</span><span class="nx">previousValues</span><span class="p">.</span><span class="nx">formValues</span><span class="p">.</span><span class="nx">preview</span> <span class="c1"># we don&#39;t want this</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p><strong>Parse error message from HTML response</strong></p>

<p>@param <code>jqXHR</code> <em>Object</em> XHR object <br />
@return <em>Object</em> Error object  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">errorParseHTML : </span><span class="nf">(jqXHR) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Assemble error message</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">status_code      = </span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">status</span>
      <span class="nv">true_status_code = </span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s">&#39;X-True-Statuscode&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>The error response comes back as HTML, which we need to pull apart
into a meaningful message of some sort using jQuery.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">tmp            = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;&lt;div /&gt;&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">jqXHR</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
      <span class="vi">@ERRORS.title   = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;h1:first&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>
      <span class="vi">@ERRORS.desc    = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">)</span>
      <span class="vi">@ERRORS.details = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ol:first&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>If there are multiple error descriptions then combine them into one
string</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="vi">@ERRORS.desc = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">desc</span><span class="p">,</span> <span class="nf">(desc) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">desc</span><span class="p">).</span><span class="nx">text</span><span class="p">()).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="vi">@ERRORS.desc = </span><span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">desc</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>We need to check the error message for lists (ol/ul). Some of the 
services incorrectly send back <ul>s so we need to check both, or
set details to null if neither are present.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">details</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="vi">@ERRORS.details = </span><span class="nx">tmp</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ul:first&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">details</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="vi">@ERRORS.details = </span><span class="kc">null</span>

      <span class="nv">tmp = </span><span class="kc">null</span> <span class="c1"># reset the container</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>If we didn't receive an X-True-Statuscode header then we prepend the
HTTP status code to the title.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">true_status_code</span><span class="o">?</span>
        <span class="vi">@ERRORS.title = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="s"> (</span><span class="si">#{</span><span class="nx">status_code</span><span class="si">}</span><span class="s">)&quot;</span>

      <span class="nx">@ERRORS</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p><strong>Parse error message from JSON embedded in HTML response</strong>
Make the rate validation override form available if this is a rate
validation issue.</p>

<p>@param <code>jqXHR</code> <em>Object</em> XHR object <br />
@param <code>json</code> <em>String</em> JSON encoded text <br />
@return <em>Object</em> Error object  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">errorParseJSON : </span><span class="nf">(jqXHR, json) -&gt;</span>
      <span class="k">if</span> <span class="nx">json</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
        <span class="nv">response = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">?</span> <span class="kc">null</span>

      <span class="k">if</span> <span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span>
        <span class="vi">@ERRORS.title   = </span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">message</span> <span class="o">?</span> <span class="kc">null</span>
        <span class="vi">@ERRORS.desc    = </span><span class="nx">response</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">detail</span> <span class="o">?</span> <span class="kc">null</span>
        <span class="vi">@ERRORS.details = </span><span class="kc">null</span>

      <span class="k">if</span> <span class="nx">@ERRORS</span><span class="p">.</span><span class="nx">title</span> <span class="o">==</span> <span class="s">&#39;Rate Validation Failed&#39;</span>
        <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#rate_validation_override&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="s">&#39;fast&#39;</span><span class="p">)</span>

      <span class="nx">@ERRORS</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p><strong>Display error message</strong> <br />
Build an error message from the error object provided by callbackError</p>

<p>@param <code>type</code> <em>String</em> warning|notice <br />
@param <code>error</code> <em>Object</em> Collection of error fragments for assembly </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">displayError : </span><span class="nf">(type, error) -&gt;</span>
      <span class="nv">msg = </span><span class="s">&quot;&lt;h3&gt;</span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="s">&lt;/h3&gt;&lt;p&gt;</span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">desc</span><span class="si">}</span><span class="s">&lt;/p&gt;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>If details exist, build list container and append to msg</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">error</span><span class="p">.</span><span class="nx">details</span><span class="o">?</span>
        <span class="nv">msg = </span><span class="s">&quot;&quot;&quot;</span>
<span class="s">            </span><span class="si">#{</span><span class="nx">msg</span><span class="si">}</span><span class="s"></span>
<span class="s">            &lt;div class=&quot;error_details&quot;&gt;</span>
<span class="s">              &lt;a href=&quot;</span><span class="err">#</span><span class="s">&quot;&gt;&lt;i class=&quot;icon-plus-sign&quot;&gt;&lt;/i&gt; Show error details&lt;/a&gt;</span>
<span class="s">              </span><span class="si">#{</span><span class="nx">error</span><span class="p">.</span><span class="nx">details</span><span class="si">}</span><span class="s"></span>
<span class="s">            &lt;/div&gt;</span>
<span class="s">          &quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Display the error message</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@PARENT_VIEW</span><span class="p">.</span><span class="nx">displayMessage</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">msg</span><span class="p">).</span><span class="nx">remove_loader</span><span class="p">()</span>

      <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Your Action View should define the following methods:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ready : </span><span class="o">-&gt;</span>

    <span class="nv">preview : </span><span class="o">-&gt;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 