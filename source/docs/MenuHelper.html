<!DOCTYPE html>  <html> <head>   <title>MenuHelper.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="AppRules.html">                 AppRules.coffee               </a>                                           <a class="source" href="BaseCollection.html">                 BaseCollection.coffee               </a>                                           <a class="source" href="BaseModel.html">                 BaseModel.coffee               </a>                                           <a class="source" href="BaseRouter.html">                 BaseRouter.coffee               </a>                                           <a class="source" href="BaseView.html">                 BaseView.coffee               </a>                                           <a class="source" href="ConfigModel.html">                 ConfigModel.coffee               </a>                                           <a class="source" href="Cookie.html">                 Cookie.coffee               </a>                                           <a class="source" href="CrippledClientSync.html">                 CrippledClientSync.coffee               </a>                                           <a class="source" href="Helpers.html">                 Helpers.coffee               </a>                                           <a class="source" href="JSONAuthSync.html">                 JSONAuthSync.coffee               </a>                                           <a class="source" href="LocalStorageSync.html">                 LocalStorageSync.coffee               </a>                                           <a class="source" href="MenuHelper.html">                 MenuHelper.coffee               </a>                                           <a class="source" href="Messenger.html">                 Messenger.coffee               </a>                                           <a class="source" href="Store.html">                 Store.coffee               </a>                                           <a class="source" href="UserModel.html">                 UserModel.coffee               </a>                                           <a class="source" href="WorkspaceCanvasView.html">                 WorkspaceCanvasView.coffee               </a>                                           <a class="source" href="WorkspaceController.html">                 WorkspaceController.coffee               </a>                                           <a class="source" href="WorkspaceLoginView.html">                 WorkspaceLoginView.coffee               </a>                                           <a class="source" href="WorkspaceNavView.html">                 WorkspaceNavView.coffee               </a>                                           <a class="source" href="WorkspaceRouter.html">                 WorkspaceRouter.coffee               </a>                                           <a class="source" href="WorkspaceStateCollection.html">                 WorkspaceStateCollection.coffee               </a>                                           <a class="source" href="WorkspaceStateModel.html">                 WorkspaceStateModel.coffee               </a>                                           <a class="source" href="app_test.html">                 app_test.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="xmlSync.html">                 xmlSync.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               MenuHelper.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;require&#39;</span><span class="p">,</span>
  <span class="s">&#39;jquery&#39;</span><span class="p">,</span>
  <span class="s">&#39;underscore&#39;</span><span class="p">,</span>
  <span class="s">&#39;mustache&#39;</span><span class="p">,</span>
  <span class="s">&#39;text!templates/tpl_main_nav.html&#39;</span><span class="p">,</span>
  <span class="s">&#39;text!templates/tpl_sub_nav_container.html&#39;</span><span class="p">,</span>
  <span class="s">&#39;text!templates/tpl_sub_nav_ul.html&#39;</span>
<span class="p">],</span> <span class="nf">(require, $, _, Mustache, tpl_main_nav, tpl_sub_nav_container, tpl_sub_nav_ul) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Menu Helper</h3>

<p>This is a set of methods to help build the Workspace Menu
by parsing the CthulhuXML of ixDirectory and ixAdmin</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">MenuHelper = </span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Store our XML documents</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">identity           : </span><span class="kc">null</span>
    <span class="nv">ixconfig           : </span><span class="kc">null</span>
    <span class="nv">tentacles          : </span><span class="kc">null</span>
    <span class="nv">menu               : </span><span class="kc">null</span>
    <span class="nv">contexts           : </span><span class="kc">null</span>
    <span class="nv">businesses         : </span><span class="kc">null</span>
    <span class="nv">app_to_context_map : </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Build Menu</h3>

<p>Iterate over the ixDirectory tentacles and ixAdmin
items to generate the workspace menu hierarchy</p>

<p>@param <code>identity</code> <em>Object</em> ixDirectory document <br />
@param <code>ixconfig</code> <em>Object</em> ixConfig document  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">build_menu : </span><span class="nf">(identity, ixconfig) -&gt;</span>

      <span class="vi">@identity = </span><span class="nx">identity</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;Identity&#39;</span><span class="p">)</span>
      <span class="vi">@ixconfig = </span><span class="nx">ixconfig</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ixConfig&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Get a nice object of business names from ixConfig</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@businesses = </span><span class="nx">@ixconfig</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ConfigItem[name=businesses]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">children</span><span class="p">()</span>
      <span class="nv">business_names = </span><span class="p">{}</span>
      <span class="nx">@businesses</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(index, item) -&gt;</span>
        <span class="nv">item = </span><span class="nx">$</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="nx">business_names</span><span class="p">[</span><span class="nx">item</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span>
      <span class="vi">@businesses = </span><span class="nx">business_names</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>These are the current possible contexts from ixConfig arranged
in an easy to access object by label (ex: cru, cruwic, etc)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@contexts = </span><span class="nx">@build_context_map</span><span class="p">(</span><span class="nx">@ixconfig</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We need to generate an object that easily lets us map
different app names to their correct context</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@app_to_context_map = </span><span class="nx">@get_context_map</span><span class="p">(</span><span class="nx">@contexts</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Parse the tentacles from ixDirectory and build an
array of the valid ones</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@ixadmin = </span><span class="nx">@identity</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;ApplicationSettings[applicationName=ixadmin][environmentName=</span><span class="si">#{</span><span class="nb">window</span><span class="p">.</span><span class="nx">ICS360_ENV</span><span class="si">}</span><span class="s">]&quot;</span><span class="p">)</span>
      <span class="vi">@tentacles = </span><span class="nx">@get_tentacles</span><span class="p">(</span><span class="nx">@ixadmin</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>If we don't have any ixAdmin entries for this env or
tentacles then this person has no access to anything</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@ixadmin</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span> <span class="nx">@tentacles</span>
        <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Now assemble the building blocks into something usable</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">@compile_menu_collection</span><span class="p">(</span><span class="nx">@businesses</span><span class="p">,</span> <span class="nx">@tentacles</span><span class="p">,</span> <span class="nx">@contexts</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Generate Menu</h3>

<p>Consume the prepared object from @compile<em>menu</em>collection and
generate the required HTML tree to make the menu</p>

<p>@param <code>data</code> <em>Object</em> results of @compile<em>menu</em>collection</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">generate_menu : </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Generate main_nav</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">main_nav = </span><span class="p">{</span> <span class="nv">main_nav : </span><span class="p">[]</span> <span class="p">}</span>
      <span class="nv">sub_nav = </span><span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Loop throug objects</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">obj</span> <span class="k">of</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Only generate a Main_Nav item if there are actual
contexts available to it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="s">&#39;contexts&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">contexts</span><span class="p">)</span>
            <span class="nx">main_nav</span><span class="p">.</span><span class="nx">main_nav</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span>
              <span class="nv">url      : </span><span class="nx">name</span>
              <span class="nv">label    : </span><span class="nx">obj</span><span class="p">.</span><span class="nx">label</span>
              <span class="nv">business : </span><span class="nx">name</span>
            <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Sub nav</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">submenu = </span><span class="p">{</span> <span class="nv">sub_nav_id : </span><span class="nx">name</span><span class="p">,</span> <span class="nv">submenu : </span><span class="s">&#39;&#39;</span> <span class="p">}</span>
        <span class="k">for</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">c_obj</span> <span class="k">of</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">contexts</span>
          <span class="nv">out       = </span><span class="p">{</span> <span class="nv">sub_nav : </span><span class="p">[]</span> <span class="p">}</span>
          <span class="nv">out.label = </span><span class="nx">@check_length</span> <span class="nx">c_obj</span><span class="p">.</span><span class="nx">label</span>
          <span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">a_obj</span> <span class="k">of</span> <span class="nx">c_obj</span><span class="p">.</span><span class="nx">apps</span>
            <span class="nx">out</span><span class="p">.</span><span class="nx">sub_nav</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span>
              <span class="nv">url       : </span><span class="nx">a_obj</span><span class="p">.</span><span class="nx">app</span>
              <span class="nv">nav_label : </span><span class="nx">a_obj</span><span class="p">.</span><span class="nx">app_label</span>
              <span class="nv">business  : </span><span class="nx">a_obj</span><span class="p">.</span><span class="nx">business</span>
              <span class="nv">env       : </span><span class="nx">a_obj</span><span class="p">.</span><span class="nx">env</span>
              <span class="nv">context   : </span><span class="nx">a_obj</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">context</span>
            <span class="p">}</span>

          <span class="nx">submenu</span><span class="p">.</span><span class="nx">submenu</span> <span class="o">+=</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span> <span class="nx">tpl_sub_nav_ul</span><span class="p">,</span> <span class="nx">out</span>
        <span class="nx">sub_nav</span> <span class="o">+=</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span> <span class="nx">tpl_sub_nav_container</span><span class="p">,</span> <span class="nx">submenu</span>

      <span class="nv">html =</span>
        <span class="s">&#39;main_nav&#39;</span> <span class="o">:</span> <span class="nx">Mustache</span><span class="p">.</span><span class="nx">render</span> <span class="nx">tpl_main_nav</span><span class="p">,</span> <span class="nx">main_nav</span>
        <span class="s">&#39;sub_nav&#39;</span>  <span class="o">:</span> <span class="nx">sub_nav</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>Compile Menu Collection</h3>

<p>Iterate over our building blocks and create a tree
of Businesses -> Contexts -> Applications</p>

<p>@param <code>businesses</code> <em>Object</em> businesses map <br />
@param <code>tentacles</code> <em>Object</em> tentacle collection <br />
@param <code>contexts</code> <em>Object</em> context collection  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">compile_menu_collection : </span><span class="nf">(businesses, tentacles, contexts) -&gt;</span>
      <span class="nv">bc = </span><span class="p">{}</span> <span class="c1"># bidness collection</span>
      <span class="k">for</span> <span class="nx">business_name</span><span class="p">,</span> <span class="nx">business_label</span> <span class="k">of</span> <span class="nx">businesses</span>
        <span class="nx">bc</span><span class="p">[</span><span class="nx">business_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nv">label : </span><span class="nx">business_label</span><span class="p">,</span> <span class="nv">contexts : </span><span class="kc">null</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Get all apps in this business</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">apps = </span><span class="p">[]</span>
        <span class="k">for</span> <span class="nx">t_name</span><span class="p">,</span> <span class="nx">t_val</span> <span class="k">of</span> <span class="nx">tentacles</span>          
          <span class="k">if</span> <span class="nx">t_val</span><span class="p">.</span><span class="nx">business</span><span class="o">?</span> <span class="o">and</span> <span class="nx">t_val</span><span class="p">.</span><span class="nx">business</span> <span class="o">is</span> <span class="nx">business_name</span>
            <span class="nx">apps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">t_val</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Get all contexts from these apps</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">groups = </span><span class="p">{}</span>
        <span class="k">for</span> <span class="nx">app</span> <span class="k">in</span> <span class="nx">apps</span>
          <span class="k">if</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="nx">groups</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">context</span>
            <span class="nx">groups</span><span class="p">[</span><span class="nx">app</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">context</span><span class="p">]</span> <span class="o">=</span> 
              <span class="nv">label : </span><span class="nx">contexts</span><span class="p">[</span><span class="nx">app</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">context</span><span class="p">].</span><span class="nx">label</span>
              <span class="nv">apps : </span><span class="p">[]</span>
            <span class="nx">groups</span><span class="p">[</span><span class="nx">app</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">context</span><span class="p">].</span><span class="nx">apps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">app</span>
          <span class="k">else</span>
            <span class="nx">groups</span><span class="p">[</span><span class="nx">app</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">context</span><span class="p">].</span><span class="nx">apps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">app</span>
        <span class="nx">bc</span><span class="p">[</span><span class="nx">business_name</span><span class="p">].</span><span class="nv">contexts = </span><span class="nx">groups</span>

      <span class="nx">bc</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>Get Tentacles</h3>

<p>Iterate over ixadmin node to extract tentacleLink nodes
and split into named pices for further processing</p>

<p>@param <code>data</code> <em>Object</em> ixAdmin node</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">get_tentacles : </span><span class="nf">(data) -&gt;</span>
      <span class="nv">data = </span><span class="nx">data</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;tentacleLink&#39;</span><span class="p">)</span>
      <span class="nv">re = </span><span class="nb">RegExp</span> <span class="nb">window</span><span class="p">.</span><span class="nx">ICS360_ENV</span><span class="p">,</span> <span class="s">&quot;gi&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Array of tentacleLink path string of the correct env</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">tentacles = </span><span class="p">[]</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">(tentacle, index) -&gt;</span>
        <span class="nv">path = </span><span class="nx">$</span><span class="p">(</span><span class="nx">tentacle</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">path</span> <span class="o">!=</span> <span class="s">&#39;undefined&#39;</span> <span class="o">and</span> <span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">re</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>8/16/12 - we are only getting Policy apps for now as per Lewisohn</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">path</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/policies/gi</span><span class="p">)</span>
            <span class="nx">tentacles</span><span class="p">.</span><span class="nx">push</span> <span class="nx">path</span>
      </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Take the tentacle path and process it, looking for valid
contexts (from ixConfig) and attempt to derive the correct
application name, etc.</p>

<p>Example path: staging-fnic-rulesets_fnic <br />
Example expl: {env}-{business}-{app}</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">processed_tentacles = </span><span class="nx">_</span><span class="p">.</span><span class="nx">map</span> <span class="nx">tentacles</span><span class="p">,</span> <span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">pieces    = </span><span class="nx">val</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;-&#39;</span>        
        <span class="p">[</span><span class="nx">env</span><span class="p">,</span> <span class="nx">business</span><span class="p">,</span> <span class="nx">app</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">pieces</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">pieces</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">pieces</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="nx">@app_to_context_map</span><span class="p">,</span> <span class="nx">app</span>
          <span class="nv">app_label = </span><span class="nx">@app_to_context_map</span><span class="p">[</span><span class="nx">app</span><span class="p">].</span><span class="nx">label</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="kc">null</span>

        <span class="nv">context = </span><span class="nx">@app_to_context_map</span><span class="p">[</span><span class="nx">app</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Introspect the contexts to get the real business unit
these tentacles belong to. We need this to round up
tentacle apps by context/business</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">context</span><span class="o">?</span> <span class="o">and</span> <span class="nx">context</span><span class="p">.</span><span class="nx">businesses</span><span class="o">?</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">context</span><span class="p">.</span><span class="nx">businesses</span>
            <span class="nv">business = </span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span> <span class="nx">context</span><span class="p">.</span><span class="nx">businesses</span><span class="p">,</span> <span class="s">&#39;name&#39;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">context</span><span class="p">.</span><span class="nx">businesses</span>
            <span class="nv">business = </span><span class="nx">context</span><span class="p">.</span><span class="nx">businesses</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span>

        <span class="p">{</span>
          <span class="s">&#39;env&#39;</span>       <span class="o">:</span> <span class="nx">env</span>
          <span class="s">&#39;business&#39;</span>  <span class="o">:</span> <span class="nx">business</span>
          <span class="s">&#39;app&#39;</span>       <span class="o">:</span> <span class="nx">app</span>
          <span class="s">&#39;app_label&#39;</span> <span class="o">:</span> <span class="nx">app_label</span>
          <span class="s">&#39;context&#39;</span>   <span class="o">:</span> <span class="nx">context</span>
          <span class="s">&#39;tentacle&#39;</span>  <span class="o">:</span> <span class="nx">val</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Return clean array</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">processed_tentacles = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">processed_tentacles</span><span class="p">,</span> <span class="nf">(item) -&gt;</span>
        <span class="nx">item</span><span class="o">?</span>

      <span class="nv">out = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>format the object a little better</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">tentacle</span> <span class="k">in</span> <span class="nx">processed_tentacles</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">tentacle</span><span class="p">.</span><span class="nx">app</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tentacle</span>

      <span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>Build Context Map</h3>

<p>Intense data massage. Moves contexts XML into a
more rational JSON style format. <strong>This is hairy.</strong></p>

<p>Output:</p>

<pre><code>contexts : {
  cru : {
     applications : {
       policies_cru : [],
       rulesets_cru : []
     },
     label : "CRU Surplus Residential and Commercial"
   },
   ...
 }
</code></pre>

<p>@param <code>data</code> <em>Object</em> @contexts collection  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">build_context_map : </span><span class="nf">(data) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Grab context nodes from XML</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">contexts = </span><span class="nx">@ixconfig</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ConfigItem[name=contexts]&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">children</span><span class="p">()</span>
      
      <span class="nv">context_map = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Loop over nodes, building map</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">contexts</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">$context = </span><span class="nx">$</span><span class="p">(</span><span class="nx">context</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Create a name object (ex: cruwic)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">item_label = </span><span class="nx">$context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ConfigItem[name=label]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>If this has an applications node then parse it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">$context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ConfigItem[name=applications]&#39;</span><span class="p">)</span>
          <span class="nv">item_apps = </span><span class="nx">$context</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ConfigItem[name=applications]&#39;</span><span class="p">).</span><span class="nx">children</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Create an Obj with the name of this context</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">out = </span><span class="nx">context_map</span><span class="p">[</span><span class="nx">$context</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Grab the label name if it exists</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">item_label</span><span class="o">?</span>
          <span class="nv">out.label = </span><span class="nx">item_label</span>

        <span class="nv">applications = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Loop over the applications nodes and build properly
named objects to store the data in. Somtimes the application
node is a single object, sometimes and array of objects.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">item_apps</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(index, app) -&gt;</span>
          <span class="nv">$app = </span><span class="nx">$</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
          <span class="nv">app_out = </span><span class="nx">applications</span><span class="p">[</span><span class="nx">$app</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Now we loop through all the application nodes and do a little
processing on them for better key/val pairs</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">for</span> <span class="nx">app_name</span><span class="p">,</span> <span class="nx">node</span> <span class="k">of</span> <span class="nx">applications</span>
          <span class="nx">applications</span><span class="p">[</span><span class="nx">app_name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@parse_application</span> <span class="nx">node</span>

        <span class="nx">out</span><span class="p">[</span><span class="s">&#39;applications&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">applications</span>
      <span class="nx">context_map</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Parse an application context object into a nicer
key/val object (flatten that sucker a little)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">parse_application : </span><span class="nf">(app) -&gt;</span>
      <span class="nv">out = </span><span class="p">{}</span>
      <span class="nv">app = </span><span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">xml2json</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">app</span><span class="p">.</span><span class="nx">ConfigItem</span><span class="p">,</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="nx">obj</span><span class="p">,</span> <span class="s">&#39;value&#39;</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">obj</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span> 
        <span class="k">else</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">has</span> <span class="nx">obj</span><span class="p">,</span> <span class="s">&#39;ConfigItem&#39;</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">obj</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">ConfigItem</span>
      <span class="k">return</span> <span class="nx">out</span>
      </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h3>Get Context Map</h3>

<p>Parses @contexts and returns a collection of the
different application names contained within the
context. We use this to find out the proper names
of apps in @tentacles. Collection is keyed with
appname.</p>

<p>Output:</p>

<pre><code>{
  agencies : {
    businesses : {
      -name : "homewise",
      ConfigItem : { ... }
      label : "Agencies",
      type : "iframe"
    }
  }
  ...
}
</code></pre>

<p>@param <code>data</code> <em>Object</em> @contexts collection  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">get_context_map : </span><span class="nf">(contexts) -&gt;</span>
      <span class="nv">out = </span><span class="p">{}</span>
      <span class="k">for</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">applications</span> <span class="k">of</span> <span class="nx">contexts</span>
        <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">applications</span><span class="p">.</span><span class="nx">applications</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="s">&#39;context&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">context</span>
      <span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Shortens a string to 25 chars and adds ellipses</p>

<p>@param <code>label</code> <em>String</em> text  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">check_length : </span><span class="nf">(label) -&gt;</span>
      <span class="k">if</span> <span class="nx">label</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">25</span>
        <span class="k">return</span> <span class="nx">label</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&amp;hellip;&#39;</span>
      <span class="nx">label</span>

  <span class="nx">MenuHelper</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 