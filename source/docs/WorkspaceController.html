<!DOCTYPE html>  <html> <head>   <title>WorkspaceController.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="AppRules.html">                 AppRules.coffee               </a>                                           <a class="source" href="BaseCollection.html">                 BaseCollection.coffee               </a>                                           <a class="source" href="BaseModel.html">                 BaseModel.coffee               </a>                                           <a class="source" href="BaseRouter.html">                 BaseRouter.coffee               </a>                                           <a class="source" href="BaseView.html">                 BaseView.coffee               </a>                                           <a class="source" href="ConfigModel.html">                 ConfigModel.coffee               </a>                                           <a class="source" href="Cookie.html">                 Cookie.coffee               </a>                                           <a class="source" href="CrippledClientSync.html">                 CrippledClientSync.coffee               </a>                                           <a class="source" href="Helpers.html">                 Helpers.coffee               </a>                                           <a class="source" href="JSONAuthSync.html">                 JSONAuthSync.coffee               </a>                                           <a class="source" href="LocalStorageSync.html">                 LocalStorageSync.coffee               </a>                                           <a class="source" href="MenuHelper.html">                 MenuHelper.coffee               </a>                                           <a class="source" href="Messenger.html">                 Messenger.coffee               </a>                                           <a class="source" href="Store.html">                 Store.coffee               </a>                                           <a class="source" href="UserModel.html">                 UserModel.coffee               </a>                                           <a class="source" href="WorkspaceCanvasView.html">                 WorkspaceCanvasView.coffee               </a>                                           <a class="source" href="WorkspaceController.html">                 WorkspaceController.coffee               </a>                                           <a class="source" href="WorkspaceLoginView.html">                 WorkspaceLoginView.coffee               </a>                                           <a class="source" href="WorkspaceNavView.html">                 WorkspaceNavView.coffee               </a>                                           <a class="source" href="WorkspaceRouter.html">                 WorkspaceRouter.coffee               </a>                                           <a class="source" href="WorkspaceStateCollection.html">                 WorkspaceStateCollection.coffee               </a>                                           <a class="source" href="WorkspaceStateModel.html">                 WorkspaceStateModel.coffee               </a>                                           <a class="source" href="app_test.html">                 app_test.coffee               </a>                                           <a class="source" href="main.html">                 main.coffee               </a>                                           <a class="source" href="xmlSync.html">                 xmlSync.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               WorkspaceController.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;jquery&#39;</span><span class="p">,</span>
  <span class="s">&#39;underscore&#39;</span><span class="p">,</span>
  <span class="s">&#39;backbone&#39;</span><span class="p">,</span>
  <span class="s">&#39;UserModel&#39;</span><span class="p">,</span>
  <span class="s">&#39;ConfigModel&#39;</span><span class="p">,</span>
  <span class="s">&#39;WorkspaceStateModel&#39;</span><span class="p">,</span>
  <span class="s">&#39;WorkspaceStateCollection&#39;</span><span class="p">,</span>
  <span class="s">&#39;WorkspaceLoginView&#39;</span><span class="p">,</span>
  <span class="s">&#39;WorkspaceCanvasView&#39;</span><span class="p">,</span>
  <span class="s">&#39;WorkspaceNavView&#39;</span><span class="p">,</span>
  <span class="s">&#39;WorkspaceRouter&#39;</span><span class="p">,</span>
  <span class="s">&#39;modules/Search/SearchContextCollection&#39;</span><span class="p">,</span>
  <span class="s">&#39;Messenger&#39;</span><span class="p">,</span>
  <span class="s">&#39;base64&#39;</span><span class="p">,</span>
  <span class="s">&#39;MenuHelper&#39;</span><span class="p">,</span>
  <span class="s">&#39;AppRules&#39;</span><span class="p">,</span>
  <span class="s">&#39;Helpers&#39;</span><span class="p">,</span>
  <span class="s">&#39;Cookie&#39;</span>
<span class="p">],</span> <span class="nf">($, _, Backbone, UserModel, ConfigModel, WorkspaceStateModel, WorkspaceStateCollection, WorkspaceLoginView, WorkspaceCanvasView, WorkspaceNavView, WorkspaceRouter, SearchContextCollection, Messenger, Base64, MenuHelper, AppRules, Helpers, Cookie, xml2json) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Global log object for debugging</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">amplify</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h3>Services</h3>

<p>Insight 360 Service URLs</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ics360 =</span>
    <span class="nv">services :</span>
      <span class="nv">ixdirectory : </span><span class="s">&#39;./ixdirectory/api/rest/v2/&#39;</span>
      <span class="nv">pxcentral   : </span><span class="s">&#39;./pxcentral/api/rest/v1/&#39;</span>
      <span class="nv">ixlibrary   : </span><span class="s">&#39;./ixlibrary/api/sdo/rest/v1/&#39;</span>
      <span class="nv">ixdoc       : </span><span class="s">&#39;./ixdoc/api/rest/v2/&#39;</span>
      <span class="nv">ixadmin     : </span><span class="s">&#39;./config/ics/staging/ixadmin&#39;</span> <span class="c1"># TESTING ONLY</span>
      <span class="nv">zendesk     : </span><span class="s">&#39;https://staging-services.icg360.org/zendesk&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Method Combinator (Decorator) 
https://github.com/raganwald/method-combinators</p>

<p>Ensure that workspace<em>state is valid
We make sure @workspace</em>state is valid before operating
on it, or return false</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">valid_workspace = </span><span class="nf">(methodBody) -&gt;</span>
    <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@workspace_state</span><span class="o">?</span> <span class="o">and</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">@workspace_state</span><span class="p">)</span>
        <span class="nx">methodBody</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Orchestrate the Workspace</h3>

<p>This controller wires together different views/models
to handle Workspace events and in general act like
a switchboard operator.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">WorkspaceController =</span>
    <span class="nv">Amplify               : </span><span class="nx">amplify</span>
    <span class="nv">$workspace_header     : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header&#39;</span><span class="p">)</span>
    <span class="nv">$workspace_button     : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#button-workspace&#39;</span><span class="p">)</span>
    <span class="nv">$workspace_breadcrumb : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#breadcrumb&#39;</span><span class="p">)</span>
    <span class="nv">$workspace_admin      : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header-admin&#39;</span><span class="p">)</span>
    <span class="nv">$workspace_canvas     : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#canvas&#39;</span><span class="p">)</span>
    <span class="nv">$workspace_tabs       : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#workspace nav ul&#39;</span><span class="p">)</span>
    <span class="nv">Router                : </span><span class="k">new</span> <span class="nx">WorkspaceRouter</span><span class="p">()</span>
    <span class="nv">Cookie                : </span><span class="k">new</span> <span class="nx">Cookie</span><span class="p">()</span>
    <span class="nv">COOKIE_NAME           : </span><span class="s">&#39;ics360_PolicyCentral&#39;</span>
    <span class="nv">services              : </span><span class="nx">ics360</span><span class="p">.</span><span class="nx">services</span>
    <span class="nv">global_flash          : </span><span class="k">new</span> <span class="nx">Messenger</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#canvas&#39;</span><span class="p">),</span> <span class="s">&#39;controller&#39;</span><span class="p">)</span>
    <span class="nv">Workspaces            : </span><span class="k">new</span> <span class="nx">WorkspaceStateCollection</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Simple logger</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">logger : </span><span class="nf">(msg) -&gt;</span>
      <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="nx">msg</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Display a flash message in the browser</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">flash : </span><span class="nf">(type, msg) -&gt;</span>
      <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@login_view</span><span class="p">.</span><span class="nx">cid</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">msg</span>    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Keep tabs on what's in our Workspace.
This should contain WorkspaceCanvasView-enabled objects</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">workspace_stack : </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Add a view to the stack, but check for duplicates first</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">stack_add : </span><span class="nf">(view) -&gt;</span>
      <span class="nv">exists = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">@workspace_stack</span><span class="p">,</span> <span class="nf">(item) -&gt;</span>
        <span class="k">return</span> <span class="nx">item</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span> <span class="o">==</span> <span class="nx">view</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">exists</span><span class="o">?</span>
        <span class="nx">@workspace_stack</span><span class="p">.</span><span class="nx">push</span> <span class="nx">view</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Remove a view from the stack</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">stack_remove : </span><span class="nf">(view) -&gt;</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@workspace_stack</span><span class="p">,</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">view</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
          <span class="nx">@workspace_stack</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Remove params from stack if present</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">view</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">params</span><span class="o">?</span>
            <span class="vi">@current_state.params = </span><span class="kc">null</span>
            <span class="nx">@set_nav_state</span><span class="p">()</span>
            <span class="nx">@update_address</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Remove all views from stack</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">stack_clear : </span><span class="nf">() -&gt;</span>
      <span class="vi">@workspace_stack = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>@workspace_state.set 'apps', [] # maintain in state</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Find a view in the stack and return it</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">stack_get : </span><span class="nf">(app) -&gt;</span>
      <span class="k">for</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">obj</span> <span class="k">of</span> <span class="nx">@workspace_stack</span>
        <span class="k">if</span> <span class="nx">app</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
          <span class="k">return</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If app is not saved in @workspace_state and is not the 
workspace defined app then we need to add it to our
stack of saved apps</p>

<p>@param <code>app</code> <em>Object</em> application config object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">state_add : </span><span class="nf">(app) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>No workspace default apps allowed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">app</span> <span class="o">is</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">app</span>
        <span class="k">return</span> <span class="kc">false</span>

      <span class="nv">saved_apps = </span><span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;apps&#39;</span>

      <span class="k">if</span> <span class="nx">saved_apps</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Check to see if this app is already in the array.
If its not, add it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">exists = </span><span class="nx">@state_exists</span> <span class="nx">app</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">exists</span><span class="o">?</span>
          <span class="nx">saved_apps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">app</span>
        <span class="k">else</span>
          <span class="k">return</span> <span class="kc">false</span>
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Otherwise create a new array of apps if this app
is not the workspace defined default</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">app</span> <span class="o">!=</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">app</span>
          <span class="nv">saved_apps = </span><span class="p">[</span><span class="nx">app</span><span class="p">]</span>

      <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;apps&#39;</span><span class="p">,</span> <span class="nx">saved_apps</span>
      <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
      <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Remove app from saved workspace state</p>

<p>@param <code>app</code> <em>Object</em> application config object  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">state_remove :</span>
      <span class="nx">valid_workspace</span> <span class="o">\</span>
      <span class="nf">(app) -&gt;</span>
        <span class="nv">saved_apps = </span><span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;apps&#39;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">saved_apps</span><span class="p">,</span> <span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">app</span> <span class="o">==</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">app</span>
            <span class="nx">saved_apps</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">1</span>
        <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;apps&#39;</span><span class="p">,</span> <span class="nx">saved_apps</span>
        <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span>
    </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Check to see if an app already exists in saved state</p>

<p>@param <code>app</code> <em>Object</em> application config object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">state_exists :</span>
      <span class="nx">valid_workspace</span> <span class="o">\</span>
      <span class="nf">(app) -&gt;</span>
        <span class="nv">saved_apps = </span><span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;apps&#39;</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">saved_apps</span><span class="p">,</span> <span class="p">(</span><span class="nx">saved</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">saved</span><span class="p">.</span><span class="nx">app</span> <span class="o">is</span> <span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
 </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Try and keep the localStorage version of app state
persisted across requests</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">set_nav_state : </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@current_state</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@workspace_state</span><span class="o">?</span>

        <span class="k">if</span> <span class="nx">@current_state</span> <span class="o">is</span> <span class="kc">undefined</span>
          <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>If this is a string, then deserialize it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">params = </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">params</span> <span class="o">?</span> <span class="kc">null</span>
        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">params</span><span class="p">)</span>
          <span class="nv">params = </span><span class="nx">Helpers</span><span class="p">.</span><span class="nx">unserialize</span> <span class="nx">params</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Get the current workspace, if not present, then
we need to create a new workspace for the current_state</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@workspace_state = </span><span class="nx">@Workspaces</span><span class="p">.</span><span class="nx">retrieve</span> <span class="nx">@current_state</span>

        <span class="k">if</span> <span class="nx">@workspace_state</span> <span class="o">is</span> <span class="kc">undefined</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">@workspace_state</span><span class="p">)</span>
          <span class="vi">@workspace_state = </span><span class="nx">@Workspaces</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nv">workspace : </span><span class="nx">@current_state</span> <span class="p">})</span>

        <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">@workspace_state</span>
          <span class="vi">@workspace_state = </span><span class="nx">@workspace_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;workspace&#39;</span><span class="p">,</span> <span class="p">{</span>
          <span class="nv">env      : </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">env</span>
          <span class="nv">business : </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">business</span>
          <span class="nv">context  : </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">context</span>
          <span class="nv">app      : </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">app</span>
          <span class="nv">module   : </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">module</span> <span class="o">?</span> <span class="kc">null</span>
          <span class="nv">params   : </span><span class="nx">params</span>
        <span class="p">}</span>
        <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">save</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Check for an identity cookie and check server for
validity. If no cookie present then just build the
login form as usual. </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">check_cookie_identity : </span><span class="o">-&gt;</span>
      <span class="nv">cookie = </span><span class="nx">@Cookie</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">@COOKIE_NAME</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">cookie</span><span class="o">?</span>
        <span class="nv">cookie = </span><span class="nx">Base64</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">cookie</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">@check_credentials</span><span class="p">(</span><span class="nx">cookie</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">cookie</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="kc">true</span>
      <span class="k">else</span>
        <span class="nx">@Router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">trigger : </span><span class="kc">true</span> <span class="p">})</span>
        <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Drop an identity cookie in the browser.
This is in the form of a username:password digest
Honestly, this is pretty insecure - should really
be using a token generated by the server and stored
in the User table. We expire this cookie after 7 days.</p>

<p>@param <code>digest</code> <em>String</em> Base64.encode username:password</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">set_cookie_identity : </span><span class="nf">(digest) -&gt;</span>
      <span class="nx">@Cookie</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">@COOKIE_NAME</span><span class="p">,</span> <span class="nx">digest</span><span class="p">,</span> <span class="p">{</span> <span class="nv">expires : </span><span class="mi">7</span><span class="p">,</span> <span class="nv">secure : </span><span class="kc">true</span> <span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Render the login form</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">build_login : </span><span class="o">-&gt;</span>
      <span class="vi">@login_view = </span><span class="k">new</span> <span class="nx">WorkspaceLoginView</span><span class="p">({</span>
          <span class="nv">controller   : </span><span class="nx">@</span>
          <span class="nv">template     : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#tpl-ics-login&#39;</span><span class="p">)</span>
          <span class="nv">template_tab : </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#tpl-workspace-tab&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>
          <span class="nv">tab_label : </span><span class="s">&#39;Login&#39;</span>
        <span class="p">})</span>
      <span class="nx">@login_view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Set a flash message listener on the login form</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">login_flash = </span><span class="k">new</span> <span class="nx">Messenger</span><span class="p">(</span><span class="nx">@login_view</span><span class="p">,</span> <span class="nx">@login_view</span><span class="p">.</span><span class="nx">cid</span><span class="p">)</span>

      <span class="k">if</span> <span class="nx">@navigation_view</span><span class="o">?</span>
        <span class="nx">@navigation_view</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>

      <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">,</span> <span class="s">&#39;65px&#39;</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;logo-background&#39;</span><span class="p">)</span>

      <span class="nx">@login_view</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Instantiate a new user and check ixDirectory
for valid credentials</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">check_credentials : </span><span class="nf">(username, password) -&gt;</span>
      <span class="vi">@user = </span><span class="k">new</span> <span class="nx">UserModel</span>
        <span class="nv">urlRoot    : </span><span class="nx">@services</span><span class="p">.</span><span class="nx">ixdirectory</span> <span class="o">+</span> <span class="s">&#39;identities&#39;</span>
        <span class="s">&#39;username&#39;</span> <span class="o">:</span> <span class="nx">username</span>
        <span class="s">&#39;password&#39;</span> <span class="o">:</span> <span class="nx">password</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>retrieve an identity document or fail</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@user</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span>
          <span class="nv">success : </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The model has to figure out what the
response state was</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">model</span><span class="p">.</span><span class="nx">response_state</span><span class="p">()</span>
            <span class="k">switch</span> <span class="nx">@user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;fetch_state&#39;</span><span class="p">).</span><span class="nx">code</span>
              <span class="k">when</span> <span class="s">&quot;200&quot;</span> <span class="k">then</span> <span class="nx">@login_success</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span>
              <span class="k">else</span> <span class="nx">@login_fail</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">@user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;fetch_state&#39;</span><span class="p">))</span>
          <span class="nv">error : </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@response_fail</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span>
        <span class="p">)</span>

      <span class="nx">@user</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Need to throw a nice error message</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">response_fail : </span><span class="nf">(model, resp) -&gt;</span>
      <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@login_view</span><span class="p">.</span><span class="nx">cid</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="s">&quot;Sorry, your password or username was incorrect&quot;</span>
      <span class="nx">@logger</span> <span class="s">&quot;Response fail: </span><span class="si">#{</span><span class="nx">resp</span><span class="p">.</span><span class="nx">status</span><span class="si">}</span><span class="s"> : </span><span class="si">#{</span><span class="nx">resp</span><span class="p">.</span><span class="nx">statusText</span><span class="si">}</span><span class="s"> - </span><span class="si">#{</span><span class="nx">resp</span><span class="p">.</span><span class="nx">responseText</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>On a successfull login have @user set some variables
and set an identity cookie to smooth logging in later.</p>

<p>@param <code>model</code> <em>Object</em> User model <br />
@param <code>resp</code> <em>Object</em> Response from server  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">login_success : </span><span class="nf">(model, resp) -&gt;</span>
      <span class="nx">@get_configs</span><span class="p">()</span>
      <span class="nx">@user</span><span class="p">.</span><span class="nx">parse_identity</span><span class="p">()</span> <span class="c1"># Additional setup on model</span>
      <span class="nx">@set_cookie_identity</span><span class="p">(</span><span class="nx">@user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;digest&#39;</span><span class="p">))</span> <span class="c1"># set cookie</span>
      <span class="nx">@set_admin_links</span><span class="p">()</span> <span class="c1"># Change admin links to name &amp; logout</span>
      <span class="nx">@show_workspace_button</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">@login_view</span><span class="o">?</span>
        <span class="nx">@login_view</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
        <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;logo-background&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>On unsuccessful login render the login form again
along with a Flash message indicating issue</p>

<p>@param <code>model</code> <em>Object</em> User model
@param <code>resp</code> <em>Object</em> Response from server
@param <code>state</code> <em>Object</em> Error code/text from server</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">login_fail : </span><span class="nf">(model, resp, state) -&gt;</span>
      <span class="nx">@Router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s">&#39;login&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nv">trigger : </span><span class="kc">true</span> <span class="p">})</span>
      <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@login_view</span><span class="p">.</span><span class="nx">cid</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="s">&quot;There was an error parsing your identity record </span><span class="si">#{</span><span class="nx">state</span><span class="p">.</span><span class="nx">text</span><span class="si">}</span><span class="s">&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Delete the identity cookie and nullify User
TODO: Need to teardown the main nav</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">logout : </span><span class="o">-&gt;</span>
      <span class="nx">@Cookie</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">@COOKIE_NAME</span><span class="p">)</span>
      <span class="vi">@user = </span><span class="kc">null</span>
      <span class="nx">@reset_admin_links</span><span class="p">()</span>
      <span class="nx">@set_breadcrumb</span><span class="p">()</span>
      <span class="nx">@hide_workspace_button</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">@navigation_view</span><span class="o">?</span>
        <span class="nx">@navigation_view</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
        <span class="nx">@teardown_workspace</span><span class="p">()</span>

      <span class="nx">@destroy_workspace_model</span><span class="p">()</span>

    <span class="nv">destroy_workspace_model :</span>
      <span class="nx">valid_workspace</span> <span class="o">\</span>
      <span class="o">-&gt;</span>
        <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span> 
        <span class="vi">@workspace_state = </span><span class="kc">null</span>
        <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s">&#39;ics_policy_central&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h3>Get Configuration Files</h3>

<p>Grab ixAdmin information and load in <code>ConfigModel</code>
Once its loaded pass it to <code>MenuHelper</code> to generate
the tree for <code>WorkspaceNavView</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">get_configs : </span><span class="o">-&gt;</span>
      <span class="vi">@config = </span><span class="k">new</span> <span class="nx">ConfigModel</span>
        <span class="nv">urlRoot : </span><span class="nx">@services</span><span class="p">.</span><span class="nx">ixadmin</span>

      <span class="nx">@config</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span>
        <span class="nv">success : </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nv">menu = </span><span class="nx">MenuHelper</span><span class="p">.</span><span class="nx">build_menu</span><span class="p">(</span><span class="nx">@user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;document&#39;</span><span class="p">),</span> <span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;document&#39;</span><span class="p">))</span>
          <span class="k">if</span> <span class="nx">menu</span> <span class="o">is</span> <span class="kc">false</span>
            <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;controller&#39;</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="s">&quot;Sorry, you do not have access to any items in this environment.&quot;</span>
            <span class="k">return</span>
          <span class="k">else</span>
            <span class="nx">@config</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;menu&#39;</span><span class="p">,</span> <span class="nx">menu</span>
            <span class="nx">@config</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;menu_html&#39;</span><span class="p">,</span> <span class="nx">MenuHelper</span><span class="p">.</span><span class="nx">generate_menu</span><span class="p">(</span><span class="nx">menu</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Instantiate our SearchContextCollection
@setup<em>search</em>storage()</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="vi">@navigation_view = </span><span class="k">new</span> <span class="nx">WorkspaceNavView</span><span class="p">({</span>
                <span class="nv">router     : </span><span class="nx">@Router</span>
                <span class="nv">controller : </span><span class="nx">@</span>
                <span class="nv">el         : </span><span class="s">&#39;#header-workspace-nav&#39;</span>
                <span class="nv">sub_el     : </span><span class="s">&#39;#workspace-subnav&#39;</span>
                <span class="nv">main_nav   : </span><span class="nx">@config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;menu_html&#39;</span><span class="p">).</span><span class="nx">main_nav</span>
                <span class="nv">sub_nav    : </span><span class="nx">@config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;menu_html&#39;</span><span class="p">).</span><span class="nx">sub_nav</span>
              <span class="p">})</span>
            <span class="nx">@navigation_view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
            </pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If our current_state is set then we should go ahead and launch.
We do this here to ensure we have @config set before attempting to
launch, which would be... bad.</p>

<p>If current_state is not set, then we check localStorage to see if
there was a previous state saved, and try to use that one.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">@check_workspace_state</span><span class="p">()</span> <span class="o">is</span> <span class="kc">false</span> <span class="c1"># Check for localStorage state</span>
              <span class="nx">@navigation_view</span><span class="p">.</span><span class="nx">toggle_nav_slide</span><span class="p">()</span> <span class="c1"># open main nav        </span>
              <span class="nx">@navigation_view</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;li a span&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;click&#39;</span><span class="p">)</span> <span class="c1"># select first item</span>

            <span class="k">if</span> <span class="nx">@current_state</span><span class="o">?</span>
              <span class="nx">@trigger</span> <span class="s">&#39;launch&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Try to throw a useful error message when possible.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">error : </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;controller&#39;</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="s">&quot;There was a problem retreiving the configuration file. Please contact support.&quot;</span>
        <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Simple delay func if we need it.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">callback_delay : </span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">setTimeout</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">ms</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h3>Check Workplace State</h3>

<p>Attempt to setup and launch workspace based on localStorage</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">check_workspace_state : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Hit localStorage directly with Amplify</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">@Amplify</span><span class="p">.</span><span class="nx">store</span><span class="p">)</span>
        <span class="nx">@check_workspace_state</span><span class="p">()</span>
      <span class="nv">raw_storage = </span><span class="nx">@Amplify</span><span class="p">.</span><span class="nx">store</span><span class="p">(</span><span class="s">&#39;ics_policy_central&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>If already a PC2 object then add a model with its ID and fetch()
otherwise create a new model (which will get a new GUID)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">raw_storage</span><span class="o">?</span>
        <span class="nv">raw_id = </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">raw_storage</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">raw_id</span><span class="o">?</span>
          <span class="nv">workspaces = </span><span class="nx">@Workspaces</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span>
              <span class="nv">id : </span><span class="nx">raw_id</span> 
            <span class="p">)</span>
          <span class="vi">@workspace_state = </span><span class="nx">workspaces</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">raw_id</span><span class="p">)</span>
          <span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">fetch</span><span class="p">(</span>
              <span class="nv">success : </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="vi">@current_state = </span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;workspace&#39;</span>
                <span class="nx">model</span><span class="p">.</span><span class="nx">build_name</span><span class="p">()</span>
                <span class="nx">@update_address</span><span class="p">()</span>
                <span class="kc">true</span>
              <span class="nv">error : </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">resp</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Make a new WorkspaceState as we had a problem.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;controller&#39;</span><span class="p">,</span> <span class="s">&#39;notice&#39;</span><span class="p">,</span> <span class="s">&quot;We had an issue with your saved state. Not major, but we&#39;re starting from scratch.&quot;</span>
                <span class="vi">@workspace_state = </span><span class="nx">@Workspaces</span><span class="p">.</span><span class="nx">create</span><span class="p">()</span>
                <span class="kc">true</span>
            <span class="p">)</span>
          <span class="kc">true</span>          
      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>If no localStorage data then make a stub object</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@workspace_state = </span><span class="p">{}</span>
        <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h3>Setup Search Storage</h3>

<p>Setup collection to save search views in local storage. We
need to attach this to the controller to ensure
that models are passed around to many instances of 
SearchModule. It's a hack, but it works for now.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">setup_search_storage : </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">@SEARCH</span><span class="o">?</span><span class="p">.</span><span class="nx">saved_searches</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>if !_.isFunction(SearchContextCollection)
  throw new Error('SearchContextCollection is not loaded properly')</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@SEARCH =</span>
          <span class="nv">saved_searches : </span><span class="k">new</span> <span class="nx">SearchContextCollection</span><span class="p">()</span>  
              
        <span class="vi">@SEARCH.saved_searches.controller = </span><span class="nx">@</span> <span class="c1"># so we can phone home</span>
        <span class="nx">@SEARCH</span><span class="p">.</span><span class="nx">saved_searches</span><span class="p">.</span><span class="nx">fetch</span><span class="p">()</span>
        <span class="nx">@SEARCH</span><span class="p">.</span><span class="nx">saved_searches</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h3>Check logged in state</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">is_loggedin : </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">@user</span><span class="o">?</span>
        <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;controller&#39;</span><span class="p">,</span> <span class="s">&#39;notice&#39;</span><span class="p">,</span> <span class="s">&quot;Please login to Policy Central to continue.&quot;</span>
        <span class="nx">@build_login</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>Launch Workspace</h3>

<p>Attempt to setup and launch workspace based on info in the menu Obj</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">launch_workspace : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>If not logged in then back to login</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@is_loggedin</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="k">return</span>

      <span class="nv">menu = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;menu&#39;</span>
      <span class="k">if</span> <span class="nx">menu</span> <span class="o">is</span> <span class="kc">false</span>
        <span class="nx">@Amplify</span><span class="p">.</span><span class="nx">publish</span> <span class="s">&#39;controller&#39;</span><span class="p">,</span> <span class="s">&#39;warning&#39;</span><span class="p">,</span> <span class="s">&quot;Sorry, you do not have access to any items in this environment.&quot;</span>
        <span class="k">return</span>

      <span class="nv">group_label = apps = </span><span class="nx">menu</span><span class="p">[</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">business</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">context</span><span class="p">].</span><span class="nx">label</span>
      <span class="nv">apps = </span><span class="nx">menu</span><span class="p">[</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">business</span><span class="p">].</span><span class="nx">contexts</span><span class="p">[</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">context</span><span class="p">].</span><span class="nx">apps</span>

      <span class="nv">app = </span><span class="nx">_</span><span class="p">.</span><span class="nx">find</span> <span class="nx">apps</span><span class="p">,</span> <span class="p">(</span><span class="nx">app</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">app</span> <span class="o">is</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>We need to destroy any existing tabs in the workspace
before loading a new one. We do this recursively to prevent
race conditions (new tabs pushing onto the stack as old ones pop off)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@teardown_workspace</span><span class="p">()</span>
      
      <span class="k">if</span> <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">95</span>
        <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s">&#39;height&#39;</span><span class="p">,</span> <span class="s">&#39;95px&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Set the path to pxCentral to the correct instance</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nv">url = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">get_pxCentral</span><span class="p">(</span><span class="nx">@workspace_state</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>testing URL
/pxcentral/api/rest/v1/
https://staging-services.ics360.org/cru-6/ 
url = url.replace('staging-services.ics360.org', 'ics-intweb-01.ics.local:1111')</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@services.pxcentral = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">url</span><span class="si">}</span><span class="s">pxcentral/api/rest/v1/&quot;</span>

      <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;cxserver&#39;</span><span class="p">,</span> <span class="s">&#39;ixdirectory&#39;</span><span class="p">,</span> <span class="s">&#39;ixprofiler&#39;</span><span class="p">,</span> <span class="s">&#39;ixrelay&#39;</span><span class="p">,</span> <span class="s">&#39;ixvocab&#39;</span><span class="p">]</span>
        <span class="nx">@services</span><span class="p">[</span><span class="nx">node</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">get_universal_service</span><span class="p">(</span><span class="nx">@workspace_state</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span>

      <span class="nx">@launch_app</span> <span class="nx">app</span>
      <span class="k">if</span> <span class="nx">@check_persisted_apps</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Is this a search? attempt to launch it</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">module</span><span class="o">?</span>
          <span class="nx">@launch_module</span><span class="p">(</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">module</span><span class="p">,</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>
        <span class="nx">@reassess_apps</span><span class="p">()</span>

      <span class="nv">data =</span>
        <span class="nv">business : </span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">business</span>
        <span class="nv">group    : </span><span class="nx">MenuHelper</span><span class="p">.</span><span class="nx">check_length</span><span class="p">(</span><span class="nx">group_label</span><span class="p">)</span>
        <span class="s">&#39;app&#39;</span>    <span class="o">:</span> <span class="nx">app</span><span class="p">.</span><span class="nx">app_label</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Set breadcrumb</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@set_breadcrumb</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Store our workplace information in localStorage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@set_nav_state</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>Build the breadcrumb in the top nav</p>

<p>@param <code>data</code> <em>Object</em> env labels</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">set_breadcrumb : </span><span class="nf">(data) -&gt;</span>
      <span class="k">if</span> <span class="nx">data</span><span class="o">?</span>
        <span class="nx">@$workspace_breadcrumb</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">          &lt;li&gt;&lt;em&gt;</span><span class="si">#{</span><span class="nx">data</span><span class="p">.</span><span class="nx">business</span><span class="si">}</span><span class="s">&lt;/em&gt;&lt;/li&gt;</span>
<span class="s">          &lt;li&gt;&lt;em&gt;</span><span class="si">#{</span><span class="nx">data</span><span class="p">.</span><span class="nx">group</span><span class="si">}</span><span class="s">&lt;/em&gt;&lt;/li&gt;</span>
<span class="s">          &lt;li&gt;&lt;em&gt;</span><span class="si">#{</span><span class="nx">data</span><span class="p">.</span><span class="nx">app</span><span class="si">}</span><span class="s">&lt;/em&gt;&lt;/li&gt;</span>
<span class="s">        &quot;&quot;&quot;</span><span class="p">)</span>
      <span class="k">else</span>
         <span class="nx">@$workspace_breadcrumb</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h3>Launch App</h3>

<p>Attempt to setup and launch app. Apps are added <br />
to the stack from the <code>WorkspaceCanvasView</code> itself
using events so that if for some reason the view
doesn't load, we don't have to add it to the stack.</p>

<p>@param <code>app</code> <em>Object</em> application config object</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">launch_app : </span><span class="nf">(app) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>If app is not saved in @workspace_state and is not the 
workspace defined app then we need to add it to our
stack of saved apps</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@state_exists</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span><span class="o">?</span>
        <span class="nx">@toggle_apps</span> <span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
      <span class="k">else</span>
        <span class="nx">@state_add</span> <span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Determine which Module to load into the view</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">rules = </span><span class="k">new</span> <span class="nx">AppRules</span><span class="p">(</span><span class="nx">app</span><span class="p">)</span>
      <span class="nv">default_workspace = </span><span class="nx">rules</span><span class="p">.</span><span class="nx">default_workspace</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Open modules defined in workspace set</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">workspace</span> <span class="k">in</span> <span class="nx">default_workspace</span>
        <span class="nx">@create_workspace</span> <span class="nx">workspace</span><span class="p">.</span><span class="nx">module</span><span class="p">,</span> <span class="nx">workspace</span><span class="p">.</span><span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h3>Launch Search App w/ params</h3>

<p>We need to launch a Search Module preloaded with
query params.</p>

<p>@param <code>params</code> <em>Object</em> query params</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">launch_module : </span><span class="nf">(module, params) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>We need to sanitize this a little</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">params</span> <span class="o">?=</span> <span class="p">{}</span>

      <span class="k">if</span> <span class="o">!</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span> <span class="o">and</span> <span class="nx">params</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span>
        <span class="nv">url = </span><span class="nx">params</span><span class="p">.</span><span class="nx">url</span>

      <span class="nv">url = </span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span> <span class="k">if</span> <span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="o">?</span>

      <span class="nv">safe_app_name = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">Helpers</span><span class="p">.</span><span class="nx">id_safe</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">safe_app_name</span> <span class="o">+=</span> <span class="s">&quot;_</span><span class="si">#{</span><span class="nx">Helpers</span><span class="p">.</span><span class="nx">id_safe</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">url</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Setup the app object to launch policy view with</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">app =</span>
        <span class="nv">app       : </span><span class="nx">safe_app_name</span>
        <span class="nv">app_label : </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">Helpers</span><span class="p">.</span><span class="nx">uc_first</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">params    : </span><span class="nx">params</span>

      <span class="nv">app.app.params = </span><span class="nx">params</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>If doesn't already exist launch it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">stack_check = </span><span class="nx">@stack_get</span> <span class="nx">safe_app_name</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">stack_check</span><span class="o">?</span>
        <span class="nx">@launch_app</span> <span class="nx">app</span>
      <span class="k">else</span>
        <span class="nx">@toggle_apps</span> <span class="nx">safe_app_name</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Instantiate a new WorkspaceCanvasView</p>

<p>@param <code>module</code> <em>String</em> name of module to load <br />
@param <code>app</code> <em>Object</em> application config object  </p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">create_workspace : </span><span class="nf">(module, app) -&gt;</span>
      <span class="nv">options =</span>
        <span class="nv">controller  : </span><span class="nx">@</span>
        <span class="nv">module_type : </span><span class="nx">module</span>
        <span class="s">&#39;app&#39;</span>       <span class="o">:</span> <span class="nx">app</span>

      <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">tab</span><span class="o">?</span>
        <span class="nv">options.template_tab = </span><span class="nx">$</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">tab</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>

      <span class="k">new</span> <span class="nx">WorkspaceCanvasView</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>If there are other apps persisted in localStorage we need
to launch those as well</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">check_persisted_apps : </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="o">!</span><span class="nx">@workspace_state</span><span class="o">?</span>
        <span class="k">return</span> <span class="kc">false</span>
      <span class="nv">saved_apps = </span><span class="nx">@workspace_state</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;apps&#39;</span>
      <span class="k">if</span> <span class="nx">saved_apps</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">app</span> <span class="k">in</span> <span class="nx">saved_apps</span>
          <span class="nx">@launch_app</span> <span class="nx">app</span>
      <span class="k">return</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h3>Update Address</h3>

<p>Set URL to whatever @current_state says it should be. Yo.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">update_address : </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@current_state</span><span class="o">?</span>
        <span class="nv">url = </span><span class="s">&quot;workspace/</span><span class="si">#{</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">env</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">business</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">context</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">app</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="k">if</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">params</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@current_state</span><span class="p">.</span><span class="nx">module</span><span class="o">?</span>
          <span class="nx">url</span> <span class="o">+=</span> <span class="s">&quot;/</span><span class="si">#{</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">module</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">Helpers</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">@current_state</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">@Router</span><span class="p">.</span><span class="nx">navigate</span> <span class="nx">url</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h3>Set Admin Links</h3>

<p>Set Admin links to user profile and logout</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">set_admin_links : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Save original state</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">!</span><span class="nx">@$workspace_admin_initial</span><span class="o">?</span>
        <span class="vi">@$workspace_admin_initial = </span><span class="nx">@$workspace_admin</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ul&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>

      <span class="nx">@$workspace_admin</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ul&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;li&gt;Welcome back &amp;nbsp;&lt;a href=&quot;</span><span class="err">#</span><span class="s">profile&quot;&gt;</span><span class="si">#{</span><span class="nx">@user</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">&lt;/a&gt;&lt;/li&gt;</span>
<span class="s">        &lt;li&gt;&lt;a href=&quot;</span><span class="err">#</span><span class="s">logout&quot;&gt;Logout&lt;/a&gt;&lt;/li&gt;</span>
<span class="s">      &quot;&quot;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h3>Reset Admin Links</h3>

<p>Set Admin links back to original state</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">reset_admin_links : </span><span class="o">-&gt;</span>
      <span class="nx">@$workspace_admin</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ul&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">@$workspace_admin_initial</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Display workspace button and breadcrumb</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">show_workspace_button : </span><span class="o">-&gt;</span>
      <span class="nx">@$workspace_button</span><span class="p">.</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header-controls span&#39;</span><span class="p">).</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
      <span class="nx">@$workspace_breadcrumb</span><span class="p">.</span><span class="nx">fadeIn</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>Display workspace button and breadcrumb</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">hide_workspace_button : </span><span class="o">-&gt;</span>
      <span class="nx">@$workspace_button</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
      <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#header-controls span&#39;</span><span class="p">).</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span>
      <span class="nx">@$workspace_breadcrumb</span><span class="p">.</span><span class="nx">fadeOut</span><span class="p">(</span><span class="mi">400</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <h3>Drop a click listener on all tabs</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">attach_tab_handlers : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Tabs</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$workspace_tabs</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="s">&#39;li a&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="nv">app_name = </span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>When a user clicks on a tab, that tabs URL
should be rendered in the address bar</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@set_active_url</span> <span class="nx">app_name</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Fallback for search tabs</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">app_name</span> <span class="o">is</span> <span class="kc">undefined</span>
          <span class="nv">app_name = </span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span>

        <span class="nx">@toggle_apps</span> <span class="nx">app_name</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Tab close icon</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$workspace_tabs</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="s">&#39;li i.icon-remove-sign&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="nx">@stack_get</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">prev</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)).</span><span class="nx">destroy</span><span class="p">()</span>
        <span class="nx">@reassess_apps</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <h3>Set Active Url</h3>

<p>When a tab is clicked, use the app_name to find
the active tab and dig into it to get the module
name and params of that tab module. Then use this
to switch the url to what it should be.</p>

<p>@param <code>app_name</code> <em>String</em> app_name from tab href</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">set_active_url : </span><span class="nf">(app_name) -&gt;</span>
      <span class="k">for</span> <span class="nx">view</span> <span class="k">in</span> <span class="nx">@workspace_stack</span>
        <span class="k">if</span> <span class="nx">app_name</span> <span class="o">==</span> <span class="nx">view</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
          <span class="nv">module = </span><span class="nx">view</span><span class="p">.</span><span class="nx">module</span>
          <span class="k">if</span> <span class="nx">module</span><span class="o">?</span> <span class="o">and</span> <span class="nx">module</span><span class="p">.</span><span class="nx">app</span><span class="o">?</span> <span class="o">and</span> <span class="nx">module</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">params</span><span class="o">?</span>
            <span class="nv">module_name = </span><span class="k">new</span> <span class="nx">AppRules</span><span class="p">(</span><span class="nx">module</span><span class="p">.</span><span class="nx">app</span><span class="p">).</span><span class="nx">app_name</span>
            <span class="nx">@Router</span><span class="p">.</span><span class="nx">append_module</span> <span class="nx">module_name</span><span class="p">,</span> <span class="nx">module</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">params</span>
          <span class="k">else</span>
            <span class="nx">@Router</span><span class="p">.</span><span class="nx">remove_module</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Failsafe for default search tab with no name</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">app_name</span> <span class="o">is</span> <span class="kc">undefined</span>
          <span class="nx">@Router</span><span class="p">.</span><span class="nx">remove_module</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Loop through app stack and switch app states</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">toggle_apps : </span><span class="nf">(app_name) -&gt;</span>
      <span class="k">for</span> <span class="nx">view</span> <span class="k">in</span> <span class="nx">@workspace_stack</span>
        <span class="k">if</span> <span class="nx">app_name</span> <span class="o">==</span> <span class="nx">view</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">activate</span><span class="p">()</span>
          <span class="vi">@active_view = </span><span class="nx">view</span>
          <span class="nx">@set_active_url</span> <span class="nx">app_name</span>
          <span class="kc">true</span>
        <span class="k">else</span>
          <span class="nx">view</span><span class="p">.</span><span class="nx">deactivate</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>Look for active views in the stack, if there are none
then activate the last one in the stack.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">reassess_apps : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>No stack, no need</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@workspace_stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="kc">false</span>

      <span class="nv">active = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">@workspace_stack</span><span class="p">,</span> <span class="nf">(view) -&gt;</span>
        <span class="k">return</span> <span class="nx">view</span><span class="p">.</span><span class="nx">is_active</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">active</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="nv">last_view = </span><span class="nx">_</span><span class="p">.</span><span class="nx">last</span> <span class="nx">@workspace_stack</span>
        <span class="nx">@toggle_apps</span> <span class="nx">last_view</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">app</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Tell every app in the stack to commit seppuku</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">teardown_workspace : </span><span class="o">-&gt;</span>
      <span class="nx">@set_breadcrumb</span><span class="p">()</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">@workspace_stack</span><span class="p">,</span> <span class="p">(</span><span class="nx">view</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">view</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()</span>
        <span class="nv">view = </span><span class="kc">null</span>
      <span class="k">if</span> <span class="nx">@workspace_stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="nx">@stack_clear</span><span class="p">()</span>
        <span class="nx">@$workspace_tabs</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="nx">$</span><span class="p">(</span><span class="s">&#39;#target&#39;</span><span class="p">).</span><span class="nx">empty</span><span class="p">()</span>
        <span class="kc">true</span>
      <span class="k">else</span>
        <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Kick off the show</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">init : </span><span class="nf">() -&gt;</span>
      <span class="nx">@callback_delay</span> <span class="mi">100</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="vi">@Router.controller = </span><span class="nx">@</span>
        <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
        <span class="nx">@check_cookie_identity</span><span class="p">()</span>
        <span class="nx">@attach_tab_handlers</span><span class="p">()</span>


  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">WorkspaceController</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Events for Controller</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;log&quot;</span><span class="p">,</span> <span class="nf">(msg) -&gt;</span>
    <span class="nx">@logger</span> <span class="nx">msg</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;login&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">@build_login</span><span class="p">()</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;logout&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">@logout</span><span class="p">()</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;launch&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
    <span class="nx">@launch_workspace</span><span class="p">()</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;search&quot;</span><span class="p">,</span> <span class="nf">(module, params) -&gt;</span>
    <span class="nx">@launch_module</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;stack_add&quot;</span><span class="p">,</span> <span class="nf">(view) -&gt;</span>
    <span class="nx">@stack_add</span> <span class="nx">view</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;stack_remove&quot;</span><span class="p">,</span> <span class="nf">(view) -&gt;</span>
    <span class="nx">@stack_remove</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span>
    <span class="nx">@state_remove</span><span class="p">(</span><span class="nx">view</span><span class="p">.</span><span class="nx">app</span><span class="p">)</span>

  <span class="nx">WorkspaceController</span><span class="p">.</span><span class="kc">on</span> <span class="s">&quot;new_tab&quot;</span><span class="p">,</span> <span class="nf">(app_name) -&gt;</span>
    <span class="nx">@toggle_apps</span> <span class="nx">app_name</span>


  

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 