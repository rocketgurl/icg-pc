// Generated by CoffeeScript 1.4.0
(function() {

  define(['jquery', 'underscore'], function($, _) {
    var Messenger;
    return Messenger = (function() {

      Messenger.prototype.animation_options = {
        "default": {
          start: {
            top: "15px"
          },
          end: {
            top: "-15px"
          }
        },
        nomove: {
          start: false,
          end: false
        }
      };

      function Messenger(view, id) {
        this.view = view;
        this.id = id;
        if (this.view.$el != null) {
          this.flash_message = this.view.$el.find("#flash-message-" + this.id);
        } else {
          this.flash_message = this.view.find("#flash-message-" + this.id);
        }
        this.container = this.findContainer(this.view);
        this.register(this.id);
      }

      Messenger.prototype.findContainer = function(view) {
        var container;
        if (view.$el != null) {
          view = view.$el;
        }
        container = view.find(".flash-message-container");
        if (container.length === 0) {
          container = view.find("#flash-message-controller");
        }
        return container;
      };

      Messenger.prototype.register = function(id) {
        var _this = this;
        return amplify.subscribe(id, function(type, msg, delay, animation) {
          var options;
          if (animation != null) {
            animation = _this.animation_options[animation];
          } else {
            animation = _this.animation_options["default"];
          }
          if (type != null) {
            _this.flash_message.addClass(type);
          }
          if (msg != null) {
            msg = "<span><i class=\"icon-remove-sign\"></i>" + msg + "</span>";
            _this.flash_message.html(msg);
            options = _.extend(animation.start, {
              opacity: 1
            });
            _this.container.show().animate(options, 500);
            if (delay != null) {
              _.delay(function() {
                options = _.extend(animation.end, {
                  opacity: 0
                });
                return _this.container.animate(options, 500, function() {
                  return $(this).hide();
                });
              }, delay);
            }
          }
          _this.flash_message.on('click', function(e) {
            e.preventDefault();
            options = {
              opacity: 0
            };
            return _this.container.animate(options, 200, function() {
              $(this).hide();
              if (_.has(animation.end, 'top')) {
                return $(this).css('top', '-100px');
              }
            });
          });
          return _this.flash_message.on('click', '.error_details a', function(e) {
            e.preventDefault();
            $(_this).next().toggle();
            return $(_this).toggle(function() {
              return $(this).html('<i class="icon-plus-sign"></i> Hide error details');
            }, function() {
              return $(this).html('<i class="icon-plus-sign"></i> Show error details');
            });
          });
        });
      };

      return Messenger;

    })();
  });

}).call(this);
