// Generated by CoffeeScript 1.4.0
(function() {

  define(['BaseView', 'Messenger', 'text!modules/ZenDesk/templates/tpl_zendesk_container.html'], function(BaseView, Messenger, tpl_zd_container) {
    var ZenDeskView;
    return ZenDeskView = BaseView.extend({
      initialize: function(options) {
        var _ref;
        _ref = [options.$el, options.policy, options.policy_view], this.$el = _ref[0], this.policy = _ref[1], this.policy_view = _ref[2];
        this.$el.append("<div id=\"zd_shim_" + this.cid + "\" class=\"zd-shim\"><div id=\"zd_loader_" + this.cid + "\" class=\"zd-loader\"></div></div>");
        return this;
      },
      fetch: function() {
        this.show();
        return this.fetch_tickets(this.policy.get_policy_id());
      },
      render: function() {
        this.remove_loader();
        return this.$el.find("#zd_shim_" + this.cid).html(this.Mustache.render(tpl_zd_container, {
          results: this.tickets.results
        }));
      },
      show: function() {
        var _this = this;
        return this.$el.fadeIn('fast', function() {
          return _this.attach_loader();
        });
      },
      hide: function() {
        return this.$el.hide();
      },
      attach_loader: function() {
        if ($("#zd_loader_" + this.cid).length > 0) {
          this.loader = this.Helpers.loader("zd_loader_" + this.cid, 80, '#696969');
          return this.loader.setFPS(48);
        }
      },
      remove_loader: function() {
        if (this.loader != null) {
          this.loader.kill();
          return $("#zd_loader_" + this.cid).hide();
        }
      },
      fetch_tickets: function(query) {
        var _this = this;
        if (_.isEmpty(query)) {
          this.Amplify.publish(this.policy_view.cid, 'warning', "This policy is unable to search the ZenDesk API at this time. Sorry.");
          return false;
        } else {
          $.ajax({
            url: this.policy_view.services.zendesk,
            type: 'GET',
            contentType: 'application/json',
            data: {
              query: query,
              sort_order: 'desc',
              sort_by: 'created_at'
            },
            dataType: 'json',
            success: function(data, textStatus, jqXHR) {
              _this.tickets = data;
              _this.render();
              return _this.policy_view.resize_workspace(_this.$el, null);
            },
            error: function(jqXHR, textStatus, errorThrown) {
              _this.Amplify.publish(_this.policy_view.cid, 'warning', "This policy is unable to access the ZenDesk API at this time. Message: " + textStatus);
              _this.remove_loader();
              return false;
            }
          });
        }
        return this;
      }
    });
  });

}).call(this);
